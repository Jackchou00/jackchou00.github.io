<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HDR Image Formats (II): JPEG and Its Modifications | JacksBlog</title>
<meta name=keywords content="JPEG file format,JPEG marker segments,multi-frame JPEG files"><meta name=description content="Learn JPEG file structure: SOI/EOI markers, metadata, JFIF format. Use a free parser to analyze binary segments (FF D8, FF D9) and compressed data."><meta name=author content="Miaosen Zhou"><link rel=canonical href=https://jackchou.top/en/posts/jpeg-structure/><link crossorigin=anonymous href=/assets/css/stylesheet.2ff386b10b02a361d472eab220247dbdf4bb7faecac9567e482555e7ba4cc9ba.css integrity="sha256-L/OGsQsCo2HUcuqyICR9vfS7f67KyVZ+SCVV57pMybo=" rel="preload stylesheet" as=style><link rel=icon href=https://jackchou.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jackchou.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jackchou.top/favicon-32x32.png><link rel=apple-touch-icon href=https://jackchou.top/apple-touch-icon.png><link rel=mask-icon href=https://jackchou.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://jackchou.top/posts/jpeg-structure/><link rel=alternate hreflang=en href=https://jackchou.top/en/posts/jpeg-structure/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://cdn.jsdelivr.net><meta property="og:url" content="https://jackchou.top/en/posts/jpeg-structure/"><meta property="og:site_name" content="JacksBlog"><meta property="og:title" content="HDR Image Formats (II): JPEG and Its Modifications"><meta property="og:description" content="Learn JPEG file structure: SOI/EOI markers, metadata, JFIF format. Use a free parser to analyze binary segments (FF D8, FF D9) and compressed data."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-24T02:00:00+08:00"><meta property="article:modified_time" content="2025-12-21T00:41:45+08:00"><meta property="article:tag" content="Code"><meta property="article:tag" content="HDR"><meta property="article:tag" content="Gainmap"><meta property="og:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp"><meta name=twitter:title content="HDR Image Formats (II): JPEG and Its Modifications"><meta name=twitter:description content="Learn JPEG file structure: SOI/EOI markers, metadata, JFIF format. Use a free parser to analyze binary segments (FF D8, FF D9) and compressed data."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts üå≥","item":"https://jackchou.top/en/posts/"},{"@type":"ListItem","position":2,"name":"HDR Image Formats (II): JPEG and Its Modifications","item":"https://jackchou.top/en/posts/jpeg-structure/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HDR Image Formats (II): JPEG and Its Modifications","name":"HDR Image Formats (II): JPEG and Its Modifications","description":"Learn JPEG file structure: SOI/EOI markers, metadata, JFIF format. Use a free parser to analyze binary segments (FF D8, FF D9) and compressed data.","keywords":["JPEG file format","JPEG marker segments","multi-frame JPEG files"],"articleBody":"What is a JPG To be precise, JPEG is a compression method that describes how to turn an image into a byte stream. What we commonly call a JPG file is actually a JFIF file, whose binary structure is a hierarchical sequence composed of multiple ‚ÄúMarkers‚Äù. However, just as in everyday communication, the following text will frequently mix these concepts.\nSimply put, a JPEG file is a collection of marker segments and compressed image data. Each marker segment begins with a specific marker that defines the purpose of that segment‚Äôs data.\nFor example, the beginning of a file is a Start of Image (SOI) marker, with the binary code FF D8, indicating that what follows is a JPG file. Its corresponding End of Image (EOI) marker is FF D9, but due to various modifications to the JPEG format, the EOI marker doesn‚Äôt necessarily appear at the very end of the file.\nAfter the SOI marker, there are some APP marker segments that provide additional information. Their identifier is the binary code FF Ex, where x can be from 0-15. The two bytes following the identifier record the length of this segment (including these two length-identifying bytes), followed by the content. Note that they are not necessarily sequential or unique; for instance, a file can have two APP1 segments.\nAPP0 is the JFIF application segment. Although it‚Äôs supposed to be mandatory, many files don‚Äôt have it. APP1 usually stores EXIF or XMP information, used for camera parameters or image-related metadata. APP2 typically holds an ICC profile. In the UltraHDR specification, HDR-related information is stored as XMP metadata in an APP1 segment.\nSimilarly, the Quantization Tables and Huffman Tables generated during JPEG compression are also placed in marker segments: DQT, with the binary code FF DB, defines the Quantization Table, and DHT, with the binary code FF C4, defines the Huffman Table.\nThen comes the Start of Frame 0 (SOF0) marker for baseline DCT (which must come after DQT), with the binary code FF C0. It stores the image‚Äôs width, height, bit depth, and other information. And then the Start of Scan (SOS) marker (which must come after the above marker segments), with the binary code FF DA. The encoded image data immediately follows the SOS part, so the two bytes in SOS that record its own length are very important, as they define the boundary between the metadata and the actual image data.\nWithin the byte stream, some FF data might appear. To prevent them from being interpreted as markers, they are followed by a 00 byte. At the end of the byte stream, the EOI marker FF D9 is used to signify the end. But other data can still follow.\nMulti-frame JPEGs In some files, you can find another SOI after an EOI, followed by another complete JFIF structure. This simple concatenation allows for several complete JPEGs to be stored in one file. Some are used as a gain map to achieve HDR, while others store a separate low-resolution image for quick previews on the camera. The biggest advantage of this concatenation is backward compatibility. Image viewers that don‚Äôt recognise multiple frames will only read the first image without throwing an error, gracefully handling backward compatibility.\nNote that ‚Äúmulti-frame‚Äù here does not refer to a thumbnail. Although a thumbnail also has a complete JPG structure, it‚Äôs usually placed inside the APP0 (JFIF) or APP1 (EXIF) segment as part of the main image. Therefore, you can‚Äôt split multi-frame JPEGs simply by searching for SOI and EOI markers, because you‚Äôll be misled by the markers within the thumbnail. In a multi-frame structure, the next SOI doesn‚Äôt necessarily follow immediately after an EOI, so you can‚Äôt just search for FF D9 FF D8 to detect a multi-frame structure either.\nIf you just want a simple way to identify multi-frame structures in a JPG file, one simple strategy is to use a ‚Äústack‚Äù. Scan from the beginning; when you find an SOI, push it onto the stack. When you find an EOI, pop an SOI from the top of the stack to pair with it. This handles the nested structure caused by thumbnails. However, it‚Äôs very likely that other marker segments also contain byte sequences identical to SOI and EOI markers, so this method is not very reliable and isn‚Äôt recommended.\nThere is a standard for multi-frame JPG files called MPF (Multi-Picture Format), developed by CIPA, which specifies the size and offset of subsequent frames in the APP2 segment of the first JFIF. However, this standard is rarely followed, and most cases are just simple, unmarked concatenations.\nOther Data In JPG images taken with an OPPO phone, you can find two complete JFIF structures. After the second EOI, you can still find some other data, including the phone model name, a JSON snippet, and so on.\n[ { \"length\": 4, \"name\": \"private.emptyspace\", \"offset\": 51, \"version\": 1 }, { \"length\": 47, \"name\": \"watermark.device\", \"offset\": 47, \"version\": 1 } ] These are likely fields used for handling watermarks in the phone‚Äôs built-in gallery app. This proprietary data can also interfere with logic that relies solely on the EOI marker to determine the end of the file.\nCode 02 JPEG Structure\njpeg_parser.py: To extract data needed for image processing and colour science from JPEGs, and considering that existing Python libraries don‚Äôt handle concatenated multi-frame JPEGs well, I wrote a simple JPEG parsing tool. It can currently parse multi-frame JPEGs correctly and extract XMP from the APP1 segment of each frame.\ncheck_soi_eoi.py: A script that uses a stack-based approach to pair SOI and EOI markers. It can correctly find all JFIF structures within a file without parsing other markers, but it cannot handle cases where identical byte codes might appear in other marker segments.\nNext, we will use this information to explore the encoding and decoding of HDR images stored in the JPEG format.\n","wordCount":"976","inLanguage":"en","image":"https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp","datePublished":"2025-08-24T02:00:00+08:00","dateModified":"2025-12-21T00:41:45+08:00","author":{"@type":"Person","name":"Miaosen Zhou"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jackchou.top/en/posts/jpeg-structure/"},"publisher":{"@type":"Organization","name":"JacksBlog","logo":{"@type":"ImageObject","url":"https://jackchou.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jackchou.top/en/ accesskey=h title="JacksBlog (Alt + H)">JacksBlog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://jackchou.top/ title=‰∏≠Êñá aria-label=‰∏≠Êñá>‰∏≠Êñá</a></li></ul></div></div><ul id=menu><li><a href=https://jackchou.top/en/posts/ title="Posts üå≥"><span>Posts üå≥</span></a></li><li><a href=https://jackchou.top/en/photos/ title="Photos üì∑"><span>Photos üì∑</span></a></li><li><a href=https://jackchou.top/en/tags/ title="Tags üè∑Ô∏è"><span>Tags üè∑Ô∏è</span></a></li><li><a href=https://jackchou.top/en/about/ title="About üòº"><span>About üòº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">HDR Image Formats (II): JPEG and Its Modifications</h1><div class=post-meta><span title='2025-08-24 02:00:00 +0800 +0800'>2025.08.24</span>&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://jackchou.top/posts/jpeg-structure/>‰∏≠Êñá</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-a-jpg aria-label="What is a JPG">What is a JPG</a></li><li><a href=#multi-frame-jpegs aria-label="Multi-frame JPEGs">Multi-frame JPEGs</a></li><li><a href=#other-data aria-label="Other Data">Other Data</a></li><li><a href=#code aria-label=Code>Code</a></li></ul></div></details></div><div class=post-content><h2 id=what-is-a-jpg>What is a JPG<a hidden class=anchor aria-hidden=true href=#what-is-a-jpg>#</a></h2><p>To be precise, JPEG is a compression method that describes how to turn an image into a byte stream. What we commonly call a JPG file is actually a JFIF file, whose binary structure is a hierarchical sequence composed of multiple &ldquo;Markers&rdquo;. However, just as in everyday communication, the following text will frequently mix these concepts.</p><p>Simply put, a JPEG file is a collection of marker segments and compressed image data. Each marker segment begins with a specific marker that defines the purpose of that segment&rsquo;s data.</p><p>For example, the beginning of a file is a Start of Image (SOI) marker, with the binary code <code>FF D8</code>, indicating that what follows is a JPG file. Its corresponding End of Image (EOI) marker is <code>FF D9</code>, but due to various modifications to the JPEG format, the EOI marker doesn&rsquo;t necessarily appear at the very end of the file.</p><p>After the SOI marker, there are some APP marker segments that provide additional information. Their identifier is the binary code <code>FF Ex</code>, where x can be from 0-15. The two bytes following the identifier record the length of this segment (including these two length-identifying bytes), followed by the content. Note that they are not necessarily sequential or unique; for instance, a file can have two APP1 segments.</p><p>APP0 is the JFIF application segment. Although it&rsquo;s supposed to be mandatory, many files don&rsquo;t have it. APP1 usually stores EXIF or XMP information, used for camera parameters or image-related metadata. APP2 typically holds an ICC profile. In the UltraHDR specification, HDR-related information is stored as XMP metadata in an APP1 segment.</p><p>Similarly, the Quantization Tables and Huffman Tables generated during JPEG compression are also placed in marker segments: DQT, with the binary code <code>FF DB</code>, defines the Quantization Table, and DHT, with the binary code <code>FF C4</code>, defines the Huffman Table.</p><p>Then comes the Start of Frame 0 (SOF0) marker for baseline DCT (which must come after DQT), with the binary code <code>FF C0</code>. It stores the image&rsquo;s width, height, bit depth, and other information. And then the Start of Scan (SOS) marker (which must come after the above marker segments), with the binary code <code>FF DA</code>. The encoded image data immediately follows the SOS part, so the two bytes in SOS that record its own length are very important, as they define the boundary between the metadata and the actual image data.</p><p>Within the byte stream, some <code>FF</code> data might appear. To prevent them from being interpreted as markers, they are followed by a <code>00</code> byte. At the end of the byte stream, the EOI marker <code>FF D9</code> is used to signify the end. But other data can still follow.</p><h2 id=multi-frame-jpegs>Multi-frame JPEGs<a hidden class=anchor aria-hidden=true href=#multi-frame-jpegs>#</a></h2><p>In some files, you can find another SOI after an EOI, followed by another complete JFIF structure. This simple concatenation allows for several complete JPEGs to be stored in one file. Some are used as a gain map to achieve HDR, while others store a separate low-resolution image for quick previews on the camera. The biggest advantage of this concatenation is backward compatibility. Image viewers that don&rsquo;t recognise multiple frames will only read the first image without throwing an error, gracefully handling backward compatibility.</p><p>Note that &ldquo;multi-frame&rdquo; here does not refer to a thumbnail. Although a thumbnail also has a complete JPG structure, it&rsquo;s usually placed inside the APP0 (JFIF) or APP1 (EXIF) segment as part of the main image. Therefore, you can&rsquo;t split multi-frame JPEGs simply by searching for SOI and EOI markers, because you&rsquo;ll be misled by the markers within the thumbnail. In a multi-frame structure, the next SOI doesn&rsquo;t necessarily follow immediately after an EOI, so you can&rsquo;t just search for <code>FF D9 FF D8</code> to detect a multi-frame structure either.</p><p>If you just want a simple way to identify multi-frame structures in a JPG file, one simple strategy is to use a &ldquo;stack&rdquo;. Scan from the beginning; when you find an SOI, push it onto the stack. When you find an EOI, pop an SOI from the top of the stack to pair with it. This handles the nested structure caused by thumbnails. However, it&rsquo;s very likely that other marker segments also contain byte sequences identical to SOI and EOI markers, so this method is not very reliable and isn&rsquo;t recommended.</p><p>There is a standard for multi-frame JPG files called MPF (Multi-Picture Format), developed by CIPA, which specifies the size and offset of subsequent frames in the APP2 segment of the first JFIF. However, this standard is rarely followed, and most cases are just simple, unmarked concatenations.</p><h2 id=other-data>Other Data<a hidden class=anchor aria-hidden=true href=#other-data>#</a></h2><p>In JPG images taken with an OPPO phone, you can find two complete JFIF structures. After the second EOI, you can still find some other data, including the phone model name, a JSON snippet, and so on.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;length&#34;</span>: <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;private.emptyspace&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;offset&#34;</span>: <span style=color:#ae81ff>51</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;length&#34;</span>: <span style=color:#ae81ff>47</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;watermark.device&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;offset&#34;</span>: <span style=color:#ae81ff>47</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>These are likely fields used for handling watermarks in the phone&rsquo;s built-in gallery app. This proprietary data can also interfere with logic that relies solely on the EOI marker to determine the end of the file.</p><h2 id=code>Code<a hidden class=anchor aria-hidden=true href=#code>#</a></h2><p><a href=https://github.com/Jackchou00/jacksblog-examples/tree/main/02%20jpeg_structure>02 JPEG Structure</a></p><p><code>jpeg_parser.py</code>: To extract data needed for image processing and colour science from JPEGs, and considering that existing Python libraries don&rsquo;t handle concatenated multi-frame JPEGs well, I wrote a simple JPEG parsing tool. It can currently parse multi-frame JPEGs correctly and extract XMP from the APP1 segment of each frame.</p><p><code>check_soi_eoi.py</code>: A script that uses a stack-based approach to pair SOI and EOI markers. It can correctly find all JFIF structures within a file without parsing other markers, but it cannot handle cases where identical byte codes might appear in other marker segments.</p><p>Next, we will use this information to explore the encoding and decoding of HDR images stored in the JPEG format.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jackchou.top/en/tags/code/>Code</a></li><li><a href=https://jackchou.top/en/tags/hdr/>HDR</a></li><li><a href=https://jackchou.top/en/tags/gainmap/>Gainmap</a></li></ul><nav class=paginav><a class=prev href=https://jackchou.top/en/posts/hdr-format-ultrahdr-mpf/><span class=title>¬´ Prev</span><br><span>HDR Image Formats (III): UltraHDR and MPF</span>
</a><a class=next href=https://jackchou.top/en/posts/llm-for-colour/><span class=title>Next ¬ª</span><br><span>Using LLMs for Colour Science: Best Practices and Test</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://jackchou.top/en/>JacksBlog</a></span> ¬∑
my friends&rsquo; websites: <a href=https://zhxwu.com/>zhxwu.com</a>, <a href=https://ylqian.com/>ylqian.com</a> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script defer crossorigin=anonymous src=/js/site.min.a576538c52b362e170acc02d53f5ce6045117863354954a8f91f10c7217d94ab.js integrity="sha256-pXZTjFKzYuFwrMAtU/XOYEUReGM1SVSo+R8QxyF9lKs="></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>