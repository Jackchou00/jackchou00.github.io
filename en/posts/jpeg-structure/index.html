<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HDR Image Format Analysis (II): JPEG and Its Modifications | üè°JacksBlog</title>
<meta name="keywords" content="Code, HDR, Gainmap">
<meta name="description" content="This is the second article in the HDR static image format analysis series. It will introduce the structure of JPEG and the current modifications made to it to support new features like HDR, which will be helpful for the future encoding and decoding of HDR images in the JPEG format.">
<meta name="author" content="Jack">
<link rel="canonical" href="https://jackchou.top/en/posts/jpeg-structure/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bb4e9ae2e440bccf3cb7d24276f41ff835376bf2c78193c51417a098608382c4.css" integrity="sha256-u06a4uRAvM88t9JCdvQf&#43;DU3a/LHgZPFFBegmGCDgsQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jackchou.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jackchou.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jackchou.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jackchou.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://jackchou.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://jackchou.top/posts/jpeg-structure/">
<link rel="alternate" hreflang="en" href="https://jackchou.top/en/posts/jpeg-structure/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js" integrity="sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Noto+Sans+SC:wght@100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">


<style>
#domain-migration-notice {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 12px 20px;
  text-align: center;
  z-index: 1000;
  font-size: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: none;
}

#domain-migration-notice.show {
  display: block;
}

#domain-migration-notice .notice-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

#domain-migration-notice .notice-text {
  flex: 1;
  text-align: center;
}

#domain-migration-notice .close-btn {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background-color 0.3s;
}

#domain-migration-notice .close-btn:hover {
  background: rgba(255,255,255,0.3);
}

#domain-migration-notice a {
  color: #ffeb3b;
  text-decoration: underline;
}

body.notice-shown {
  padding-top: 60px;
}

@media (max-width: 768px) {
  #domain-migration-notice {
    padding: 10px 15px;
    font-size: 13px;
  }
  
  #domain-migration-notice .notice-content {
    flex-direction: column;
    gap: 8px;
  }
  
  body.notice-shown {
    padding-top: 80px;
  }
}
</style>

<script>
(function() {
  
  const expiryDate = new Date('2025-10-31');
  const now = new Date();
  
  if (now > expiryDate) {
    return; 
  }
  
  
  if (localStorage.getItem('domain-migration-dismissed') === 'true') {
    return;
  }
  
  
  const noticeHTML = `
    <div id="domain-migration-notice">
      <div class="notice-content">
        <div class="notice-text">
          <span class="zh-notice" style="display: none;">
            üëã ÂÜçËßÅÔºåjackchou00.icu    üöÄ Êñ∞ÁöÑÊóÖÈÄîÔºå‰ªé <a href="https://jackchou.top">jackchou.top</a> Ëµ∑Á®ã
          </span>
          <span class="en-notice" style="display: none;">
            üëã Goodbye, jackchou00.icu    üöÄ A new chapter will begin at <a href="https://jackchou.top">jackchou.top</a>
          </span>
        </div>
        <button class="close-btn" onclick="dismissNotice()">‚úï</button>
      </div>
    </div>
  `;
  
  
  document.addEventListener('DOMContentLoaded', function() {
    
    document.body.insertAdjacentHTML('afterbegin', noticeHTML);
    
    
    const isEnglish = document.documentElement.lang === 'en' || window.location.pathname.startsWith('/en/');
    const zhNotice = document.querySelector('.zh-notice');
    const enNotice = document.querySelector('.en-notice');
    
    if (isEnglish && enNotice) {
      enNotice.style.display = 'inline';
    } else if (zhNotice) {
      zhNotice.style.display = 'inline';
    }
    
    
    const notice = document.getElementById('domain-migration-notice');
    if (notice) {
      notice.classList.add('show');
      document.body.classList.add('notice-shown');
    }
  });
  
  
  window.dismissNotice = function() {
    const notice = document.getElementById('domain-migration-notice');
    if (notice) {
      notice.style.display = 'none';
      document.body.classList.remove('notice-shown');
      localStorage.setItem('domain-migration-dismissed', 'true');
    }
  };
})();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4dc1311d77d6840123f21aa2f8a31c84";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><meta property="og:url" content="https://jackchou.top/en/posts/jpeg-structure/">
  <meta property="og:site_name" content="üè°JacksBlog">
  <meta property="og:title" content="HDR Image Format Analysis (II): JPEG and Its Modifications">
  <meta property="og:description" content="This is the second article in the HDR static image format analysis series. It will introduce the structure of JPEG and the current modifications made to it to support new features like HDR, which will be helpful for the future encoding and decoding of HDR images in the JPEG format.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-24T02:00:00+08:00">
    <meta property="article:modified_time" content="2025-08-24T02:00:00+08:00">
    <meta property="article:tag" content="Code">
    <meta property="article:tag" content="HDR">
    <meta property="article:tag" content="Gainmap">
      <meta property="og:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:title" content="HDR Image Format Analysis (II): JPEG and Its Modifications">
<meta name="twitter:description" content="This is the second article in the HDR static image format analysis series. It will introduce the structure of JPEG and the current modifications made to it to support new features like HDR, which will be helpful for the future encoding and decoding of HDR images in the JPEG format.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts üå≥",
      "item": "https://jackchou.top/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HDR Image Format Analysis (II): JPEG and Its Modifications",
      "item": "https://jackchou.top/en/posts/jpeg-structure/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HDR Image Format Analysis (II): JPEG and Its Modifications",
  "name": "HDR Image Format Analysis (II): JPEG and Its Modifications",
  "description": "This is the second article in the HDR static image format analysis series. It will introduce the structure of JPEG and the current modifications made to it to support new features like HDR, which will be helpful for the future encoding and decoding of HDR images in the JPEG format.",
  "keywords": [
    "Code", "HDR", "Gainmap"
  ],
  "articleBody": "What is a JPG To be precise, JPEG is a compression method that describes how to turn an image into a byte stream. What we commonly call a JPG file is actually a JFIF file, whose binary structure is a hierarchical sequence composed of multiple ‚ÄúMarkers‚Äù. However, just as in everyday communication, the following text will frequently mix these concepts.\nSimply put, a JPEG file is a collection of marker segments and compressed image data. Each marker segment begins with a specific marker that defines the purpose of that segment‚Äôs data.\nFor example, the beginning of a file is a Start of Image (SOI) marker, with the binary code FF D8, indicating that what follows is a JPG file. Its corresponding End of Image (EOI) marker is FF D9, but due to various modifications to the JPEG format, the EOI marker doesn‚Äôt necessarily appear at the very end of the file.\nAfter the SOI marker, there are some APP marker segments that provide additional information. Their identifier is the binary code FF Ex, where x can be from 0-15. The two bytes following the identifier record the length of this segment (including these two length-identifying bytes), followed by the content. Note that they are not necessarily sequential or unique; for instance, a file can have two APP1 segments.\nAPP0 is the JFIF application segment. Although it‚Äôs supposed to be mandatory, many files don‚Äôt have it. APP1 usually stores EXIF or XMP information, used for camera parameters or image-related metadata. APP2 typically holds an ICC profile. In the UltraHDR specification, HDR-related information is stored as XMP metadata in an APP1 segment.\nSimilarly, the Quantization Tables and Huffman Tables generated during JPEG compression are also placed in marker segments: DQT, with the binary code FF DB, defines the Quantization Table, and DHT, with the binary code FF C4, defines the Huffman Table.\nThen comes the Start of Frame 0 (SOF0) marker for baseline DCT (which must come after DQT), with the binary code FF C0. It stores the image‚Äôs width, height, bit depth, and other information. And then the Start of Scan (SOS) marker (which must come after the above marker segments), with the binary code FF DA. The encoded image data immediately follows the SOS part, so the two bytes in SOS that record its own length are very important, as they define the boundary between the metadata and the actual image data.\nWithin the byte stream, some FF data might appear. To prevent them from being interpreted as markers, they are followed by a 00 byte. At the end of the byte stream, the EOI marker FF D9 is used to signify the end. But other data can still follow.\nMulti-frame JPEGs In some files, you can find another SOI after an EOI, followed by another complete JFIF structure. This simple concatenation allows for several complete JPEGs to be stored in one file. Some are used as a gain map to achieve HDR, while others store a separate low-resolution image for quick previews on the camera. The biggest advantage of this concatenation is backward compatibility. Image viewers that don‚Äôt recognise multiple frames will only read the first image without throwing an error, gracefully handling backward compatibility.\nNote that ‚Äúmulti-frame‚Äù here does not refer to a thumbnail. Although a thumbnail also has a complete JPG structure, it‚Äôs usually placed inside the APP0 (JFIF) or APP1 (EXIF) segment as part of the main image. Therefore, you can‚Äôt split multi-frame JPEGs simply by searching for SOI and EOI markers, because you‚Äôll be misled by the markers within the thumbnail. In a multi-frame structure, the next SOI doesn‚Äôt necessarily follow immediately after an EOI, so you can‚Äôt just search for FF D9 FF D8 to detect a multi-frame structure either.\nIf you just want a simple way to identify multi-frame structures in a JPG file, one simple strategy is to use a ‚Äústack‚Äù. Scan from the beginning; when you find an SOI, push it onto the stack. When you find an EOI, pop an SOI from the top of the stack to pair with it. This handles the nested structure caused by thumbnails. However, it‚Äôs very likely that other marker segments also contain byte sequences identical to SOI and EOI markers, so this method is not very reliable and isn‚Äôt recommended.\nThere is a standard for multi-frame JPG files called MPF (Multi-Picture Format), developed by CIPA, which specifies the size and offset of subsequent frames in the APP2 segment of the first JFIF. However, this standard is rarely followed, and most cases are just simple, unmarked concatenations.\nOther Data In JPG images taken with an OPPO phone, you can find two complete JFIF structures. After the second EOI, you can still find some other data, including the phone model name, a JSON snippet, and so on.\n[ { \"length\": 4, \"name\": \"private.emptyspace\", \"offset\": 51, \"version\": 1 }, { \"length\": 47, \"name\": \"watermark.device\", \"offset\": 47, \"version\": 1 } ] These are likely fields used for handling watermarks in the phone‚Äôs built-in gallery app. This proprietary data can also interfere with logic that relies solely on the EOI marker to determine the end of the file.\nCode 02 JPEG Structure\njpeg_parser.py: To extract data needed for image processing and colour science from JPEGs, and considering that existing Python libraries don‚Äôt handle concatenated multi-frame JPEGs well, I wrote a simple JPEG parsing tool. It can currently parse multi-frame JPEGs correctly and extract XMP from the APP1 segment of each frame.\ncheck_soi_eoi.py: A script that uses a stack-based approach to pair SOI and EOI markers. It can correctly find all JFIF structures within a file without parsing other markers, but it cannot handle cases where identical byte codes might appear in other marker segments.\nNext, we will use this information to explore the encoding and decoding of HDR images stored in the JPEG format.\n",
  "wordCount" : "976",
  "inLanguage": "en",
  "image": "https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp","datePublished": "2025-08-24T02:00:00+08:00",
  "dateModified": "2025-08-24T02:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Jack"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jackchou.top/en/posts/jpeg-structure/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "üè°JacksBlog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jackchou.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jackchou.top/en/" accesskey="h" title="üè°JacksBlog (Alt + H)">üè°JacksBlog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jackchou.top/" title="‰∏≠Êñá"
                            aria-label="‰∏≠Êñá">Zh-Cn</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jackchou.top/en/posts/" title="Posts üå≥">
                    <span>Posts üå≥</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/photos/" title="Photos üì∑">
                    <span>Photos üì∑</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/tags/" title="Tags üè∑Ô∏è">
                    <span>Tags üè∑Ô∏è</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/about/" title="About üòº">
                    <span>About üòº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      HDR Image Format Analysis (II): JPEG and Its Modifications
    </h1>
    <div class="post-description">
      This is the second article in the HDR static image format analysis series. It will introduce the structure of JPEG and the current modifications made to it to support new features like HDR, which will be helpful for the future encoding and decoding of HDR images in the JPEG format.
    </div>
    <div class="post-meta"><span title='2025-08-24 02:00:00 +0800 +0800'>2025.08.24</span>&nbsp;¬∑&nbsp;Jack&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://jackchou.top/posts/jpeg-structure/">Zh-Cn</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#what-is-a-jpg" aria-label="What is a JPG">What is a JPG</a></li>
                <li>
                    <a href="#multi-frame-jpegs" aria-label="Multi-frame JPEGs">Multi-frame JPEGs</a></li>
                <li>
                    <a href="#other-data" aria-label="Other Data">Other Data</a></li>
                <li>
                    <a href="#code" aria-label="Code">Code</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="what-is-a-jpg">What is a JPG<a hidden class="anchor" aria-hidden="true" href="#what-is-a-jpg">#</a></h2>
<p>To be precise, JPEG is a compression method that describes how to turn an image into a byte stream. What we commonly call a JPG file is actually a JFIF file, whose binary structure is a hierarchical sequence composed of multiple &ldquo;Markers&rdquo;. However, just as in everyday communication, the following text will frequently mix these concepts.</p>
<p>Simply put, a JPEG file is a collection of marker segments and compressed image data. Each marker segment begins with a specific marker that defines the purpose of that segment&rsquo;s data.</p>
<p>For example, the beginning of a file is a Start of Image (SOI) marker, with the binary code <code>FF D8</code>, indicating that what follows is a JPG file. Its corresponding End of Image (EOI) marker is <code>FF D9</code>, but due to various modifications to the JPEG format, the EOI marker doesn&rsquo;t necessarily appear at the very end of the file.</p>
<p>After the SOI marker, there are some APP marker segments that provide additional information. Their identifier is the binary code <code>FF Ex</code>, where x can be from 0-15. The two bytes following the identifier record the length of this segment (including these two length-identifying bytes), followed by the content. Note that they are not necessarily sequential or unique; for instance, a file can have two APP1 segments.</p>
<p>APP0 is the JFIF application segment. Although it&rsquo;s supposed to be mandatory, many files don&rsquo;t have it. APP1 usually stores EXIF or XMP information, used for camera parameters or image-related metadata. APP2 typically holds an ICC profile. In the UltraHDR specification, HDR-related information is stored as XMP metadata in an APP1 segment.</p>
<p>Similarly, the Quantization Tables and Huffman Tables generated during JPEG compression are also placed in marker segments: DQT, with the binary code <code>FF DB</code>, defines the Quantization Table, and DHT, with the binary code <code>FF C4</code>, defines the Huffman Table.</p>
<p>Then comes the Start of Frame 0 (SOF0) marker for baseline DCT (which must come after DQT), with the binary code <code>FF C0</code>. It stores the image&rsquo;s width, height, bit depth, and other information. And then the Start of Scan (SOS) marker (which must come after the above marker segments), with the binary code <code>FF DA</code>. The encoded image data immediately follows the SOS part, so the two bytes in SOS that record its own length are very important, as they define the boundary between the metadata and the actual image data.</p>
<p>Within the byte stream, some <code>FF</code> data might appear. To prevent them from being interpreted as markers, they are followed by a <code>00</code> byte. At the end of the byte stream, the EOI marker <code>FF D9</code> is used to signify the end. But other data can still follow.</p>
<h2 id="multi-frame-jpegs">Multi-frame JPEGs<a hidden class="anchor" aria-hidden="true" href="#multi-frame-jpegs">#</a></h2>
<p>In some files, you can find another SOI after an EOI, followed by another complete JFIF structure. This simple concatenation allows for several complete JPEGs to be stored in one file. Some are used as a gain map to achieve HDR, while others store a separate low-resolution image for quick previews on the camera. The biggest advantage of this concatenation is backward compatibility. Image viewers that don&rsquo;t recognise multiple frames will only read the first image without throwing an error, gracefully handling backward compatibility.</p>
<p>Note that &ldquo;multi-frame&rdquo; here does not refer to a thumbnail. Although a thumbnail also has a complete JPG structure, it&rsquo;s usually placed inside the APP0 (JFIF) or APP1 (EXIF) segment as part of the main image. Therefore, you can&rsquo;t split multi-frame JPEGs simply by searching for SOI and EOI markers, because you&rsquo;ll be misled by the markers within the thumbnail. In a multi-frame structure, the next SOI doesn&rsquo;t necessarily follow immediately after an EOI, so you can&rsquo;t just search for <code>FF D9 FF D8</code> to detect a multi-frame structure either.</p>
<p>If you just want a simple way to identify multi-frame structures in a JPG file, one simple strategy is to use a &ldquo;stack&rdquo;. Scan from the beginning; when you find an SOI, push it onto the stack. When you find an EOI, pop an SOI from the top of the stack to pair with it. This handles the nested structure caused by thumbnails. However, it&rsquo;s very likely that other marker segments also contain byte sequences identical to SOI and EOI markers, so this method is not very reliable and isn&rsquo;t recommended.</p>
<p>There is a standard for multi-frame JPG files called MPF (Multi-Picture Format), developed by CIPA, which specifies the size and offset of subsequent frames in the APP2 segment of the first JFIF. However, this standard is rarely followed, and most cases are just simple, unmarked concatenations.</p>
<h2 id="other-data">Other Data<a hidden class="anchor" aria-hidden="true" href="#other-data">#</a></h2>
<p>In JPG images taken with an OPPO phone, you can find two complete JFIF structures. After the second EOI, you can still find some other data, including the phone model name, a JSON snippet, and so on.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;length&#34;</span>: <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;private.emptyspace&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;offset&#34;</span>: <span style="color:#ae81ff">51</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;length&#34;</span>: <span style="color:#ae81ff">47</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;watermark.device&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;offset&#34;</span>: <span style="color:#ae81ff">47</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>These are likely fields used for handling watermarks in the phone&rsquo;s built-in gallery app. This proprietary data can also interfere with logic that relies solely on the EOI marker to determine the end of the file.</p>
<h2 id="code">Code<a hidden class="anchor" aria-hidden="true" href="#code">#</a></h2>
<p><a href="https://github.com/Jackchou00/jacksblog-examples/tree/main/02%20jpeg_structure">02 JPEG Structure</a></p>
<p><code>jpeg_parser.py</code>: To extract data needed for image processing and colour science from JPEGs, and considering that existing Python libraries don&rsquo;t handle concatenated multi-frame JPEGs well, I wrote a simple JPEG parsing tool. It can currently parse multi-frame JPEGs correctly and extract XMP from the APP1 segment of each frame.</p>
<p><code>check_soi_eoi.py</code>: A script that uses a stack-based approach to pair SOI and EOI markers. It can correctly find all JFIF structures within a file without parsing other markers, but it cannot handle cases where identical byte codes might appear in other marker segments.</p>
<p>Next, we will use this information to explore the encoding and decoding of HDR images stored in the JPEG format.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jackchou.top/en/tags/code/">Code</a></li>
      <li><a href="https://jackchou.top/en/tags/hdr/">HDR</a></li>
      <li><a href="https://jackchou.top/en/tags/gainmap/">Gainmap</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jackchou.top/en/">üè°JacksBlog</a></span> ¬∑ 
        my friends&rsquo; websites: <a href="https://zhxwu.com/">zhxwu.com</a>, <a href="https://ylqian.com/">ylqian.com</a> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div style="text-align: center; margin-top: 10px; margin-bottom: 20px; width: 100%; display: flex; justify-content: center;">
    <img src="https://visitor-badge.laobi.icu/badge?page_id=jacksblog" alt="visitors" style="max-width: 120px; height: auto;" />
</div>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
