<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array | JacksBlog</title>
<meta name="keywords" content="Image Signal Processor, Colour Space Conversion, RAW image pre-processing, Python rawpy RAW processing, RAW RGB to XYZ conversion, XYZ to sRGB transformation, Colour Correction Matrix">
<meta name="description" content="Forge your own ISP from RAW to sRGB using color science, CCM, and gamut mapping‚Äîcraft a custom processor like a true pixel engineer.">
<meta name="author" content="Miaosen Zhou">
<link rel="canonical" href="https://jackchou.top/en/posts/isp-01/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e30af01949f15b214a659db89950589c44040efcfcdeec2087ad8629d77c216e.css" integrity="sha256-4wrwGUnxWyFKZZ24mVBYnEQEDvz83uwgh62GKdd8IW4=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jackchou.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jackchou.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jackchou.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jackchou.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://jackchou.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://jackchou.top/posts/isp-01/">
<link rel="alternate" hreflang="en" href="https://jackchou.top/en/posts/isp-01/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js" integrity="sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&family=Noto+Sans+SC:wght@100..900&family=Sen:wght@400..800&display=swap" rel="stylesheet"><script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
        c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
        t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "u9z1afks70");
</script><meta property="og:url" content="https://jackchou.top/en/posts/isp-01/">
  <meta property="og:site_name" content="JacksBlog">
  <meta property="og:title" content="Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array">
  <meta property="og:description" content="Forge your own ISP from RAW to sRGB using color science, CCM, and gamut mapping‚Äîcraft a custom processor like a true pixel engineer.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-04T00:00:00+08:00">
    <meta property="article:modified_time" content="2025-07-24T21:31:53+08:00">
    <meta property="article:tag" content="Colour">
    <meta property="article:tag" content="CCM">
    <meta property="article:tag" content="ISP">
      <meta property="og:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:title" content="Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array">
<meta name="twitter:description" content="Forge your own ISP from RAW to sRGB using color science, CCM, and gamut mapping‚Äîcraft a custom processor like a true pixel engineer.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts üå≥",
      "item": "https://jackchou.top/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array",
      "item": "https://jackchou.top/en/posts/isp-01/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array",
  "name": "Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array",
  "description": "Forge your own ISP from RAW to sRGB using color science, CCM, and gamut mapping‚Äîcraft a custom processor like a true pixel engineer.",
  "keywords": [
    "Image Signal Processor", "Colour Space Conversion", "RAW image pre-processing", "Python rawpy RAW processing", "RAW RGB to XYZ conversion", "XYZ to sRGB transformation", "Colour Correction Matrix"
  ],
  "articleBody": " Viewing Notice: The abstract and chuunibyou sections were written by DeepSeek R1, which has even more outrageous content.\n‚ÄúIntroduction to ISP Forging: Crafting Your ‚ÄòGenshin Vision‚Äô RAW Processor from Scratch‚Äù ‚ÄúDoctor, You Won‚Äôt Even Call Me an ISP: The Three Primaries and the Foolish Hero‚Äôs Set‚Äù ‚ÄúPixel Engineer Training Day 1: How to Make Wild RAW RGB Bow Down to Humanity‚Äôs Colour Tyranny‚Äù ¬ß0. Prologue: The Hero‚Äôs Awakening‚ÄîFinding an ‚ÄúISP Beginner‚Äôs Guide‚Äù in the Pixel Wasteland The ISP (Image Signal Processor) is responsible for converting the RAW image output by the sensor into an image that can be displayed on the screen. This typically involves various colour space conversions, processing, and mapping.\nThis series will start from the most basic ISP, gradually adding modules to address encountered issues and improve image quality.\nNext, we will implement the most fundamental two-step ISP to acquire our initial weapon.\n¬ß1. The Ideal RAW Image The ideal starting point is a three-channel image with values ranging from 0 to 1, where 0 represents no input and 1 represents the sensor‚Äôs saturation value. However, the RAW image output by the camera contains black level compensation, has not been demosaiced, and is encoded in the camera manufacturer‚Äôs proprietary format.\nFortunately, there are many open-source tools available to help us with this pre-processing, such as dcraw and libraw. Rawpy is a Python wrapper around LibRaw, and with the following code, we can read a RAW image as an ideal numpy array:\ndef read_raw_image(path): with rawpy.imread(path) as raw: rgb = raw.postprocess( gamma=(1, 1), output_bps=16, use_auto_wb=False, use_camera_wb=False, user_wb=[1, 1, 1, 1], output_color=rawpy.ColorSpace.raw, no_auto_bright=True, half_size=True, ) rgb = rgb / 65535.0 return rgb Here, rgb is a three-dimensional numpy array with the shape (H, W, 3), where H and W are the height and width of the image respectively. This represents the pre-processed ideal RAW image.\nIf you encode this directly as an image, what you get is the ‚Äúoriginal image‚Äù.\n¬ß2. From RAW RGB to XYZ See the prequel: Colour Space Conversion: RAW and XYZ.\nThe CCM (Colour Correction Matrix) is a 3x3 matrix used to convert RAW RGB to XYZ.\nccm = np.array( [[1.297, 0.558, 0.0596], [0.0793, 0.569, -0.1675], [0.1033, -0.1577, 1.2465]] ) cameraRGB_2D = cameraRGB.reshape(-1, 3) XYZ_2D = np.dot(cameraRGB_2D, ccm) XYZ = XYZ_2D.reshape(cameraRGB.shape) The two reshape steps here are for performing matrix multiplication. If further operations are needed later, you can temporarily retain the vector form.\nAt this point, the resulting XYZ is an estimate of the tristimulus values under the shooting environment. Thus, we have converted from the camera‚Äôs unique spectral response to a unified colour space. This operation does not take into account the absolute values of the tristimulus values; if you need to adjust the overall luminance, operating on XYZ is quite reasonable, such as multiplying by a factor to simulate exposure compensation.\n¬ß3. From XYZ to sRGB See the prequel: Colour Space Conversion: XYZ and sRGB.\nM_XYZ2sRGB = np.array( [[3.2406, -1.5372, -0.4986], [-0.9689, 1.8758, 0.0415], [0.0557, -0.2040, 1.0570]] ) sRGB_linear_2D = np.dot(XYZ_2D, M_XYZ2sRGB.T) sRGB_linear = sRGB_linear_2D.reshape(cameraRGB.shape) sRGB_linear_clipped = np.clip(sRGB_linear, 0, 1) sRGB = np.where( sRGB_linear_clipped \u003c= 0.0031308, 12.92 * sRGB_linear_clipped, 1.055 * np.power(sRGB_linear_clipped, 1 / 2.4) - 0.055, ) These operations include colour space conversion and the OETF (opto-electronic transfer function), converting XYZ to sRGB space. sRGB is a three-channel image in the 0‚Äì1 range and can be displayed directly on a screen. Note that before applying the OETF, the linear space sRGB_linear must be constrained to the 0‚Äì1 range. This step effectively clips any out-of-gamut colours directly, ensuring absolute colour reproduction within the gamut‚Äîa simplest form of gamut mapping.\n¬ß4. Initial Weapon Forging Report At this point, we have completed the most basic ISP. Although simple, the key point is that every step is supported by colour science theory.\nTo demonstrate how fragile this ISP is, let‚Äôs light this lamp and encounter the first problem.\nHighlight overflow: When the sensor‚Äôs saturation value is exceeded, the sensor records it as (1, 1, 1). After processing with the initial version of the ISP, such a pixel becomes (1, 0.8, 1) and appears pink. A simple and crude solution is to detect saturated pixels in cameraRGB; if any are found, simply display them as white.\nIn the future, we will supplement the omitted modules from this initial version, resolve the various issues encountered, and gradually improve image quality.\n",
  "wordCount" : "723",
  "inLanguage": "en",
  "image": "https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp","datePublished": "2025-03-04T00:00:00+08:00",
  "dateModified": "2025-07-24T21:31:53+08:00",
  "author":{
    "@type": "Person",
    "name": "Miaosen Zhou"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jackchou.top/en/posts/isp-01/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "JacksBlog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jackchou.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jackchou.top/en/" accesskey="h" title="JacksBlog (Alt + H)">JacksBlog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jackchou.top/" title="‰∏≠Êñá"
                            aria-label="‰∏≠Êñá">‰∏≠Êñá</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jackchou.top/en/posts/" title="Posts üå≥">
                    <span>Posts üå≥</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/photos/" title="Photos üì∑">
                    <span>Photos üì∑</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/tags/" title="Tags üè∑Ô∏è">
                    <span>Tags üè∑Ô∏è</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/en/about/" title="About üòº">
                    <span>About üòº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Reincarnated into the ISP Isekai Day 0: Lost in the RAW Forest, I Summon RGB with a 3x3 Magic Array
    </h1>
    
    <div class="post-meta"><span title='2025-03-04 00:00:00 +0800 +0800'>2025.03.04</span>&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://jackchou.top/posts/isp-01/">‰∏≠Êñá</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#0-prologue-the-heros-awakeningfinding-an-isp-beginners-guide-in-the-pixel-wasteland" aria-label="¬ß0. Prologue: The Hero&rsquo;s Awakening‚ÄîFinding an &ldquo;ISP Beginner&rsquo;s Guide&rdquo; in the Pixel Wasteland">¬ß0. Prologue: The Hero&rsquo;s Awakening‚ÄîFinding an &ldquo;ISP Beginner&rsquo;s Guide&rdquo; in the Pixel Wasteland</a></li>
                <li>
                    <a href="#1-the-ideal-raw-image" aria-label="¬ß1. The Ideal RAW Image">¬ß1. The Ideal RAW Image</a></li>
                <li>
                    <a href="#2-from-raw-rgb-to-xyz" aria-label="¬ß2. From RAW RGB to XYZ">¬ß2. From RAW RGB to XYZ</a></li>
                <li>
                    <a href="#3-from-xyz-to-srgb" aria-label="¬ß3. From XYZ to sRGB">¬ß3. From XYZ to sRGB</a></li>
                <li>
                    <a href="#4-initial-weapon-forging-report" aria-label="¬ß4. Initial Weapon Forging Report">¬ß4. Initial Weapon Forging Report</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><blockquote>
<p>Viewing Notice: The abstract and chuunibyou sections were written by DeepSeek R1, which has even more outrageous content.</p>
<ul>
<li>&ldquo;Introduction to ISP Forging: Crafting Your &lsquo;Genshin Vision&rsquo; RAW Processor from Scratch&rdquo;</li>
<li>&ldquo;Doctor, You Won&rsquo;t Even Call Me an ISP: The Three Primaries and the Foolish Hero&rsquo;s Set&rdquo;</li>
<li>&ldquo;Pixel Engineer Training Day 1: How to Make Wild RAW RGB Bow Down to Humanity&rsquo;s Colour Tyranny&rdquo;</li>
</ul>
</blockquote>
<h2 id="0-prologue-the-heros-awakeningfinding-an-isp-beginners-guide-in-the-pixel-wasteland">¬ß0. Prologue: The Hero&rsquo;s Awakening‚ÄîFinding an &ldquo;ISP Beginner&rsquo;s Guide&rdquo; in the Pixel Wasteland<a hidden class="anchor" aria-hidden="true" href="#0-prologue-the-heros-awakeningfinding-an-isp-beginners-guide-in-the-pixel-wasteland">#</a></h2>
<p>The ISP (Image Signal Processor) is responsible for converting the RAW image output by the sensor into an image that can be displayed on the screen. This typically involves various colour space conversions, processing, and mapping.</p>
<p>This series will start from the most basic ISP, gradually adding modules to address encountered issues and improve image quality.</p>
<p>Next, we will implement the most fundamental two-step ISP to acquire our initial weapon.</p>
<h2 id="1-the-ideal-raw-image">¬ß1. The Ideal RAW Image<a hidden class="anchor" aria-hidden="true" href="#1-the-ideal-raw-image">#</a></h2>
<p>The ideal starting point is a three-channel image with values ranging from 0 to 1, where 0 represents no input and 1 represents the sensor‚Äôs saturation value. However, the RAW image output by the camera contains black level compensation, has not been demosaiced, and is encoded in the camera manufacturer&rsquo;s proprietary format.</p>
<p>Fortunately, there are many open-source tools available to help us with this pre-processing, such as dcraw and libraw. Rawpy is a Python wrapper around LibRaw, and with the following code, we can read a RAW image as an ideal numpy array:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_raw_image</span>(path):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> rawpy<span style="color:#f92672">.</span>imread(path) <span style="color:#66d9ef">as</span> raw:
</span></span><span style="display:flex;"><span>        rgb <span style="color:#f92672">=</span> raw<span style="color:#f92672">.</span>postprocess(
</span></span><span style="display:flex;"><span>            gamma<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            output_bps<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>            use_auto_wb<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            use_camera_wb<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            user_wb<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>            output_color<span style="color:#f92672">=</span>rawpy<span style="color:#f92672">.</span>ColorSpace<span style="color:#f92672">.</span>raw,
</span></span><span style="display:flex;"><span>            no_auto_bright<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            half_size<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    rgb <span style="color:#f92672">=</span> rgb <span style="color:#f92672">/</span> <span style="color:#ae81ff">65535.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> rgb
</span></span></code></pre></div><p>Here, <code>rgb</code> is a three-dimensional numpy array with the shape <code>(H, W, 3)</code>, where <code>H</code> and <code>W</code> are the height and width of the image respectively. This represents the pre-processed ideal RAW image.</p>
<p>If you encode this directly as an image, what you get is the &ldquo;original image&rdquo;.</p>
<p><img alt="In a sense, the RAW original image" loading="lazy" src="https://img.jackchou.top/jack-img/2025/03/4d8b79729fe910c67f91fcffc78d5ada.jpg"></p>
<h2 id="2-from-raw-rgb-to-xyz">¬ß2. From RAW RGB to XYZ<a hidden class="anchor" aria-hidden="true" href="#2-from-raw-rgb-to-xyz">#</a></h2>
<p>See the prequel: <a href="/en/posts/ccm-02-raw-xyz/">Colour Space Conversion: RAW and XYZ</a>.</p>
<p>The CCM (Colour Correction Matrix) is a 3x3 matrix used to convert RAW RGB to XYZ.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ccm <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(
</span></span><span style="display:flex;"><span>    [[<span style="color:#ae81ff">1.297</span>, <span style="color:#ae81ff">0.558</span>, <span style="color:#ae81ff">0.0596</span>], 
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0.0793</span>, <span style="color:#ae81ff">0.569</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1675</span>], 
</span></span><span style="display:flex;"><span>    [<span style="color:#ae81ff">0.1033</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1577</span>, <span style="color:#ae81ff">1.2465</span>]]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>cameraRGB_2D <span style="color:#f92672">=</span> cameraRGB<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>XYZ_2D <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(cameraRGB_2D, ccm)
</span></span><span style="display:flex;"><span>XYZ <span style="color:#f92672">=</span> XYZ_2D<span style="color:#f92672">.</span>reshape(cameraRGB<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><p>The two <code>reshape</code> steps here are for performing matrix multiplication. If further operations are needed later, you can temporarily retain the vector form.</p>
<p>At this point, the resulting <code>XYZ</code> is an estimate of the tristimulus values under the shooting environment. Thus, we have converted from the camera‚Äôs unique spectral response to a unified colour space. This operation does not take into account the absolute values of the tristimulus values; if you need to adjust the overall luminance, operating on <code>XYZ</code> is quite reasonable, such as multiplying by a factor to simulate exposure compensation.</p>
<h2 id="3-from-xyz-to-srgb">¬ß3. From XYZ to sRGB<a hidden class="anchor" aria-hidden="true" href="#3-from-xyz-to-srgb">#</a></h2>
<p>See the prequel: <a href="/en/posts/ccm-01-rgb-xyz/">Colour Space Conversion: XYZ and sRGB</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>M_XYZ2sRGB <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(
</span></span><span style="display:flex;"><span>    [[<span style="color:#ae81ff">3.2406</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.5372</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.4986</span>],
</span></span><span style="display:flex;"><span>     [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.9689</span>, <span style="color:#ae81ff">1.8758</span>, <span style="color:#ae81ff">0.0415</span>],
</span></span><span style="display:flex;"><span>     [<span style="color:#ae81ff">0.0557</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2040</span>, <span style="color:#ae81ff">1.0570</span>]]
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>sRGB_linear_2D <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(XYZ_2D, M_XYZ2sRGB<span style="color:#f92672">.</span>T)
</span></span><span style="display:flex;"><span>sRGB_linear <span style="color:#f92672">=</span> sRGB_linear_2D<span style="color:#f92672">.</span>reshape(cameraRGB<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>sRGB_linear_clipped <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>clip(sRGB_linear, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>sRGB <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(
</span></span><span style="display:flex;"><span>    sRGB_linear_clipped <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0.0031308</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">12.92</span> <span style="color:#f92672">*</span> sRGB_linear_clipped,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1.055</span> <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>power(sRGB_linear_clipped, <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2.4</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.055</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>These operations include colour space conversion and the OETF (opto-electronic transfer function), converting <code>XYZ</code> to sRGB space. <code>sRGB</code> is a three-channel image in the 0‚Äì1 range and can be displayed directly on a screen. Note that before applying the OETF, the linear space <code>sRGB_linear</code> must be constrained to the 0‚Äì1 range. This step effectively clips any out-of-gamut colours directly, ensuring absolute colour reproduction within the gamut‚Äîa simplest form of gamut mapping.</p>
<p><img alt="Image produced by the simplest ISP" loading="lazy" src="https://img.jackchou.top/jack-img/2025/03/bd95f086f23749155d25bbdd7f38cd53.jpg"></p>
<h2 id="4-initial-weapon-forging-report">¬ß4. Initial Weapon Forging Report<a hidden class="anchor" aria-hidden="true" href="#4-initial-weapon-forging-report">#</a></h2>
<p>At this point, we have completed the most basic ISP. Although simple, <strong>the key point is that every step is supported by colour science theory</strong>.</p>
<p>To demonstrate how fragile this ISP is, let‚Äôs light this lamp and encounter the first problem.</p>
<p><img alt="A case of highlight error" loading="lazy" src="https://img.jackchou.top/jack-img/2025/03/94bade9205e040c5ea04fa8acdfd9449.jpg"></p>
<p>Highlight overflow: When the sensor&rsquo;s saturation value is exceeded, the sensor records it as (1, 1, 1). After processing with the initial version of the ISP, such a pixel becomes (1, 0.8, 1) and appears pink. A simple and crude solution is to detect saturated pixels in cameraRGB; if any are found, simply display them as white.</p>
<p>In the future, we will supplement the omitted modules from this initial version, resolve the various issues encountered, and gradually improve image quality.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jackchou.top/en/tags/colour/">Colour</a></li>
      <li><a href="https://jackchou.top/en/tags/ccm/">CCM</a></li>
      <li><a href="https://jackchou.top/en/tags/isp/">ISP</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jackchou.top/en/posts/display-reflectance/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>Reflectance: A Second Path to Readability in Bright Environments</span>
  </a>
  <a class="next" href="https://jackchou.top/en/posts/ccm-02-raw-xyz/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Colour Space Conversion: RAW to XYZ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jackchou.top/en/">JacksBlog</a></span> ¬∑ 
        my friends&rsquo; websites: <a href="https://zhxwu.com/">zhxwu.com</a>, <a href="https://ylqian.com/">ylqian.com</a> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div style="text-align: center; margin-top: 10px; margin-bottom: 20px; width: 100%; display: flex; justify-content: center;">
    <img src="https://visitor-badge.laobi.icu/badge?page_id=jacksblog" alt="visitors" style="max-width: 120px; height: auto;" />
</div><script>
(() => {
    const images = document.querySelectorAll('.post-content img');
    if (!images.length) return;

    const overlay = document.createElement('div');
    overlay.className = 'image-lightbox';
    overlay.innerHTML = '<img class="image-lightbox__img" alt="" />';

    const overlayImg = overlay.querySelector('img');
    const closeOverlay = () => {
        overlay.classList.remove('is-visible');
        overlayImg.removeAttribute('src');
        document.body.style.removeProperty('overflow');
    };

    overlay.addEventListener('click', closeOverlay);
    document.addEventListener('keyup', (event) => {
        if (event.key === 'Escape' && overlay.classList.contains('is-visible')) {
            closeOverlay();
        }
    });

    document.body.appendChild(overlay);

    images.forEach((img) => {
        img.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();

            const source = img.dataset.zoomSrc || img.currentSrc || img.src;
            const cleanSrc = source.split('#')[0];

            overlayImg.src = cleanSrc;
            overlayImg.alt = img.alt || '';

            overlay.classList.add('is-visible');
            document.body.style.setProperty('overflow', 'hidden');
        });
    });
})();
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
