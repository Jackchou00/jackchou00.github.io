<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改 | 🏡JacksBlog</title>
<meta name="keywords" content="Code, HDR, Gainmap">
<meta name="description" content="这是 HDR 静态图像格式解析系列的第二篇，将介绍 JPEG 的结构，以及目前对 JPEG 进行的修改，使其支持 HDR 等新特性，将为之后 JPEG 格式的 HDR 图像编解码提供帮助。">
<meta name="author" content="">
<link rel="canonical" href="https://jackchou.top/posts/jpeg-structure/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bb4e9ae2e440bccf3cb7d24276f41ff835376bf2c78193c51417a098608382c4.css" integrity="sha256-u06a4uRAvM88t9JCdvQf&#43;DU3a/LHgZPFFBegmGCDgsQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jackchou.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jackchou.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jackchou.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jackchou.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://jackchou.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://jackchou.top/posts/jpeg-structure/">
<link rel="alternate" hreflang="en" href="https://jackchou.top/en/posts/jpeg-structure/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" integrity="sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js" integrity="sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Noto+Sans+SC:wght@100..900&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">


<style>
#domain-migration-notice {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 12px 20px;
  text-align: center;
  z-index: 1000;
  font-size: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: none;
}

#domain-migration-notice.show {
  display: block;
}

#domain-migration-notice .notice-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}

#domain-migration-notice .notice-text {
  flex: 1;
  text-align: center;
}

#domain-migration-notice .close-btn {
  background: rgba(255,255,255,0.2);
  border: 1px solid rgba(255,255,255,0.3);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background-color 0.3s;
}

#domain-migration-notice .close-btn:hover {
  background: rgba(255,255,255,0.3);
}

#domain-migration-notice a {
  color: #ffeb3b;
  text-decoration: underline;
}

body.notice-shown {
  padding-top: 60px;
}

@media (max-width: 768px) {
  #domain-migration-notice {
    padding: 10px 15px;
    font-size: 13px;
  }
  
  #domain-migration-notice .notice-content {
    flex-direction: column;
    gap: 8px;
  }
  
  body.notice-shown {
    padding-top: 80px;
  }
}
</style>

<script>
(function() {
  
  const expiryDate = new Date('2025-10-31');
  const now = new Date();
  
  if (now > expiryDate) {
    return; 
  }
  
  
  if (localStorage.getItem('domain-migration-dismissed') === 'true') {
    return;
  }
  
  
  const noticeHTML = `
    <div id="domain-migration-notice">
      <div class="notice-content">
        <div class="notice-text">
          <span class="zh-notice" style="display: none;">
            👋 再见，jackchou00.icu    🚀 新的旅途，从 <a href="https://jackchou.top">jackchou.top</a> 起程
          </span>
          <span class="en-notice" style="display: none;">
            👋 Goodbye, jackchou00.icu    🚀 A new chapter will begin at <a href="https://jackchou.top">jackchou.top</a>
          </span>
        </div>
        <button class="close-btn" onclick="dismissNotice()">✕</button>
      </div>
    </div>
  `;
  
  
  document.addEventListener('DOMContentLoaded', function() {
    
    document.body.insertAdjacentHTML('afterbegin', noticeHTML);
    
    
    const isEnglish = document.documentElement.lang === 'en' || window.location.pathname.startsWith('/en/');
    const zhNotice = document.querySelector('.zh-notice');
    const enNotice = document.querySelector('.en-notice');
    
    if (isEnglish && enNotice) {
      enNotice.style.display = 'inline';
    } else if (zhNotice) {
      zhNotice.style.display = 'inline';
    }
    
    
    const notice = document.getElementById('domain-migration-notice');
    if (notice) {
      notice.classList.add('show');
      document.body.classList.add('notice-shown');
    }
  });
  
  
  window.dismissNotice = function() {
    const notice = document.getElementById('domain-migration-notice');
    if (notice) {
      notice.style.display = 'none';
      document.body.classList.remove('notice-shown');
      localStorage.setItem('domain-migration-dismissed', 'true');
    }
  };
})();
</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4dc1311d77d6840123f21aa2f8a31c84";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><meta property="og:url" content="https://jackchou.top/posts/jpeg-structure/">
  <meta property="og:site_name" content="🏡JacksBlog">
  <meta property="og:title" content="HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改">
  <meta property="og:description" content="这是 HDR 静态图像格式解析系列的第二篇，将介绍 JPEG 的结构，以及目前对 JPEG 进行的修改，使其支持 HDR 等新特性，将为之后 JPEG 格式的 HDR 图像编解码提供帮助。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-24T02:00:00+08:00">
    <meta property="article:modified_time" content="2025-08-24T02:00:00+08:00">
    <meta property="article:tag" content="Code">
    <meta property="article:tag" content="HDR">
    <meta property="article:tag" content="Gainmap">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改">
<meta name="twitter:description" content="这是 HDR 静态图像格式解析系列的第二篇，将介绍 JPEG 的结构，以及目前对 JPEG 进行的修改，使其支持 HDR 等新特性，将为之后 JPEG 格式的 HDR 图像编解码提供帮助。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "文章 🌳",
      "item": "https://jackchou.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改",
      "item": "https://jackchou.top/posts/jpeg-structure/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改",
  "name": "HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改",
  "description": "这是 HDR 静态图像格式解析系列的第二篇，将介绍 JPEG 的结构，以及目前对 JPEG 进行的修改，使其支持 HDR 等新特性，将为之后 JPEG 格式的 HDR 图像编解码提供帮助。",
  "keywords": [
    "Code", "HDR", "Gainmap"
  ],
  "articleBody": "什么是 JPG 咬文嚼字的说，JPEG 是一种压缩方法，描述了如何将影像变成字节流，我们常说的 JPG 文件实际上指的是 JFIF，其文件的二进制结构是一个层次化的、由多个“标记”（Marker）组成的序列，不过正如日常交流，下文会大量混用这些概念。\n简单来说，一个 JPEG 文件就是一大堆标记段（Marker Segments） 和压缩图像数据的集合。每个标记段都以一个特定的标记开始，用来定义该段数据的用途。\n比如说，文件的开头是一个图像开始标记（SOI），其二进制码为 FF D8，表示接下来的内容将是一个 JPG 文件。与之对应的结束标记（EOI）是 FF D9，但由于各种对 JPG 格式的魔改，结束标记不一定出现在文件的最末尾。\n开始标记之后，紧接着是一些 APP 标记段，用来提供一些额外信息，其标识二进制码为 FF Ex，x 可以从 0-15，标识之后的两个字节记录这一段的长度（包括这两个标识长度的字节），之后是内容。注意不一定是按顺序和唯一的，比如一个文件可以有两个 APP1 段。\nAPP0 是 JFIF 应用段，虽说是强制要求，但也有不少文件没有这一段。APP1 通常存放 EXIF 或 XMP 信息，用来放一些相机参数或图像相关的元数据，APP2 通常放 ICC 文件。在 UltraHDR 规范中，HDR 相关的信息就是通过 XMP 元数据存放在 APP1 段中的。\n类似的，JPEG 压缩过程产生的量化表和哈夫曼表也是放在标记段中，分别是定义量化表的 DQT，二进制码 FF DB 和定义哈夫曼表的 DHT，二进制码 FF C4。\n然后，是基线帧的开始标记 SOF0（必须在 DQT 之后），二进制码为 FF C0，它存储了图像的宽高、位深等信息。以及开始扫描的标记 SOS （必须在以上标识段之后），二进制码为 FF DA，SOS 之后，紧接着是编码后的图像数据，所以 SOS 中记录其自身长度的两个字节很重要，因为它界定了元数据和真正图像数据的边界。\n在字节流中，还可能会出现一些 FF 数据，为了避免他们也被当作标识符，需要在后面加上 00，字节流的最后，使用结束符 EOI FF D9 来标识。但之后还可以有别的东西。\n多帧的 JPG 一些文件里可以在 EOI 之后找到下一个 SOI，然后又是一个完整的 JFIF 结构。这种简单的拼接就可以在一个文件里放下好几张完整的 JPG，有些是作为 Gainmap 使用，来实现 HDR，有些则是另外存一个低分辨率的图，用来在相机内实现快速预览。这种拼接的最大好处是向后兼容。不识别多帧的看图软件只会读取第一张图，而不会报错，优雅地实现了功能降级。\n注意，此处的多帧并非指缩略图（Thumbnail），它虽然也具有完整的 JPG 结构，但是一般放在 APP0 (JFIF) 或者 APP1 (EXIF) 里，作为上层文件的一部分。因此，不能通过直接查找 SOI 和 EOI 的方式来分割多帧 JPG，因为会受到缩略图中标识符的干扰，多帧结构中，EOI 之后也不一定紧接着下一个 SOI，所以也不能直接查找 FF D9 FF D8 来判断是否是多帧结构。\n如果只想简单辨认 JPG 文件中的多帧结构，一种简易的策略是“栈”，从前往后，找到一个 SOI 就将其压入栈中，找到一个 EOI 就从栈顶取一个 SOI 与之配对，以此来处理缩略图造成的嵌套关系。但别的标识段中很可能也存在与 SOI 和 EOI 相同的二进制码，所以这种方法的通用性很差，不建议这样操作。\n多帧格式的 JPG 文件有对应的标准，叫 MPF（Multi-Picture Format），是由 CIPA 制定的，在第一个 JFIF 的 APP2 中，写上之后几帧的大小和偏移量，但遵守的情况较少，多数情况还是无标识的简单拼接。\n其他的数据 在 OPPO 手机拍的 JPG 图片中，能找到两个完整的 JFIF 结构，在第二个 EOI 之后，还能找到一些东西。包括手机的型号，一段 json 等。\n[ { \"length\": 4, \"name\": \"private.emptyspace\", \"offset\": 51, \"version\": 1 }, { \"length\": 47, \"name\": \"watermark.device\", \"offset\": 47, \"version\": 1 } ] 可能是用来处理机内相册中水印的字段，这些私有数据也会干扰单纯用 EOI 判断文件结束的逻辑。\n代码 02 JPEG Structure\njpeg_parser.py：为了从 JPEG 中提取图像处理和色彩科学所需的数据，考虑到目前 Python 的现有库对拼接的多帧 JPEG 文件支持不好，写了一个简易的解析 JPEG 工具，目前可以正确解析多帧 JPEG，从每帧的 APP1 段中提取 XMP。\ncheck_soi_eoi.py：一个用栈思想实现的 SOI 和 EOI 配对脚本，在不解析其他标识符的情况下，正确找到文件中的所有 JFIF 结构，但不能处理别的标识段中可能出现的相同二进制码。\n之后，我们将利用这些信息，进行以 JPEG 格式保存的 HDR 图像的编解码研究。\n",
  "wordCount" : "202",
  "inLanguage": "zh-cn",
  "datePublished": "2025-08-24T02:00:00+08:00",
  "dateModified": "2025-08-24T02:00:00+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jackchou.top/posts/jpeg-structure/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "🏡JacksBlog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jackchou.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jackchou.top/" accesskey="h" title="🏡JacksBlog (Alt + H)">🏡JacksBlog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jackchou.top/en/" title="English"
                            aria-label="English">En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jackchou.top/posts/" title="文章 🌳">
                    <span>文章 🌳</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/photos/" title="照片 📷">
                    <span>照片 📷</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/tags/" title="标签 🏷️">
                    <span>标签 🏷️</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/about/" title="关于 😼">
                    <span>关于 😼</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      HDR 图像格式解析（二）：JPEG 和对 JPEG 的魔改
    </h1>
    <div class="post-description">
      这是 HDR 静态图像格式解析系列的第二篇，将介绍 JPEG 的结构，以及目前对 JPEG 进行的修改，使其支持 HDR 等新特性，将为之后 JPEG 格式的 HDR 图像编解码提供帮助。
    </div>
    <div class="post-meta"><span title='2025-08-24 02:00:00 +0800 +0800'>2025.08.24</span>&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://jackchou.top/en/posts/jpeg-structure/">En</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-jpg" aria-label="什么是 JPG">什么是 JPG</a></li>
                <li>
                    <a href="#%e5%a4%9a%e5%b8%a7%e7%9a%84-jpg" aria-label="多帧的 JPG">多帧的 JPG</a></li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e7%9a%84%e6%95%b0%e6%8d%ae" aria-label="其他的数据">其他的数据</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81" aria-label="代码">代码</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="什么是-jpg">什么是 JPG<a hidden class="anchor" aria-hidden="true" href="#什么是-jpg">#</a></h2>
<p>咬文嚼字的说，JPEG 是一种压缩方法，描述了如何将影像变成字节流，我们常说的 JPG 文件实际上指的是 JFIF，其文件的二进制结构是一个层次化的、由多个“标记”（Marker）组成的序列，不过正如日常交流，下文会大量混用这些概念。</p>
<p>简单来说，一个 JPEG 文件就是一大堆标记段（Marker Segments） 和压缩图像数据的集合。每个标记段都以一个特定的标记开始，用来定义该段数据的用途。</p>
<p>比如说，文件的开头是一个图像开始标记（SOI），其二进制码为 <code>FF D8</code>，表示接下来的内容将是一个 JPG 文件。与之对应的结束标记（EOI）是 <code>FF D9</code>，但由于各种对 JPG 格式的魔改，结束标记不一定出现在文件的最末尾。</p>
<p>开始标记之后，紧接着是一些 APP 标记段，用来提供一些额外信息，其标识二进制码为 <code>FF Ex</code>，x 可以从 0-15，标识之后的两个字节记录这一段的长度（包括这两个标识长度的字节），之后是内容。注意不一定是按顺序和唯一的，比如一个文件可以有两个 APP1 段。</p>
<p>APP0 是 JFIF 应用段，虽说是强制要求，但也有不少文件没有这一段。APP1 通常存放 EXIF 或 XMP 信息，用来放一些相机参数或图像相关的元数据，APP2 通常放 ICC 文件。在 UltraHDR 规范中，HDR 相关的信息就是通过 XMP 元数据存放在 APP1 段中的。</p>
<p>类似的，JPEG 压缩过程产生的量化表和哈夫曼表也是放在标记段中，分别是定义量化表的 DQT，二进制码 <code>FF DB</code> 和定义哈夫曼表的 DHT，二进制码 <code>FF C4</code>。</p>
<p>然后，是基线帧的开始标记 SOF0（必须在 DQT 之后），二进制码为 <code>FF C0</code>，它存储了图像的宽高、位深等信息。以及开始扫描的标记 SOS （必须在以上标识段之后），二进制码为 <code>FF DA</code>，SOS 之后，紧接着是编码后的图像数据，所以 SOS 中记录其自身长度的两个字节很重要，因为它界定了元数据和真正图像数据的边界。</p>
<p>在字节流中，还可能会出现一些 <code>FF</code> 数据，为了避免他们也被当作标识符，需要在后面加上 <code>00</code>，字节流的最后，使用结束符 EOI <code>FF D9</code> 来标识。但之后还可以有别的东西。</p>
<h2 id="多帧的-jpg">多帧的 JPG<a hidden class="anchor" aria-hidden="true" href="#多帧的-jpg">#</a></h2>
<p>一些文件里可以在 EOI 之后找到下一个 SOI，然后又是一个完整的 JFIF 结构。这种简单的拼接就可以在一个文件里放下好几张完整的 JPG，有些是作为 Gainmap 使用，来实现 HDR，有些则是另外存一个低分辨率的图，用来在相机内实现快速预览。这种拼接的最大好处是向后兼容。不识别多帧的看图软件只会读取第一张图，而不会报错，优雅地实现了功能降级。</p>
<p>注意，此处的多帧并非指缩略图（Thumbnail），它虽然也具有完整的 JPG 结构，但是一般放在 APP0 (JFIF) 或者 APP1 (EXIF) 里，作为上层文件的一部分。因此，不能通过直接查找 SOI 和 EOI 的方式来分割多帧 JPG，因为会受到缩略图中标识符的干扰，多帧结构中，EOI 之后也不一定紧接着下一个 SOI，所以也不能直接查找 <code>FF D9 FF D8</code> 来判断是否是多帧结构。</p>
<p>如果只想简单辨认 JPG 文件中的多帧结构，一种简易的策略是“栈”，从前往后，找到一个 SOI 就将其压入栈中，找到一个 EOI 就从栈顶取一个 SOI 与之配对，以此来处理缩略图造成的嵌套关系。但别的标识段中很可能也存在与 SOI 和 EOI 相同的二进制码，所以这种方法的通用性很差，不建议这样操作。</p>
<p>多帧格式的 JPG 文件有对应的标准，叫 MPF（Multi-Picture Format），是由 CIPA 制定的，在第一个 JFIF 的 APP2 中，写上之后几帧的大小和偏移量，但遵守的情况较少，多数情况还是无标识的简单拼接。</p>
<h2 id="其他的数据">其他的数据<a hidden class="anchor" aria-hidden="true" href="#其他的数据">#</a></h2>
<p>在 OPPO 手机拍的 JPG 图片中，能找到两个完整的 JFIF 结构，在第二个 EOI 之后，还能找到一些东西。包括手机的型号，一段 json 等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;length&#34;</span>: <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;private.emptyspace&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;offset&#34;</span>: <span style="color:#ae81ff">51</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;length&#34;</span>: <span style="color:#ae81ff">47</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;watermark.device&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;offset&#34;</span>: <span style="color:#ae81ff">47</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>可能是用来处理机内相册中水印的字段，这些私有数据也会干扰单纯用 EOI 判断文件结束的逻辑。</p>
<h2 id="代码">代码<a hidden class="anchor" aria-hidden="true" href="#代码">#</a></h2>
<p><a href="https://github.com/Jackchou00/jacksblog-examples/tree/main/02%20jpeg_structure">02 JPEG Structure</a></p>
<p><code>jpeg_parser.py</code>：为了从 JPEG 中提取图像处理和色彩科学所需的数据，考虑到目前 Python 的现有库对拼接的多帧 JPEG 文件支持不好，写了一个简易的解析 JPEG 工具，目前可以正确解析多帧 JPEG，从每帧的 APP1 段中提取 XMP。</p>
<p><code>check_soi_eoi.py</code>：一个用栈思想实现的 SOI 和 EOI 配对脚本，在不解析其他标识符的情况下，正确找到文件中的所有 JFIF 结构，但不能处理别的标识段中可能出现的相同二进制码。</p>
<p>之后，我们将利用这些信息，进行以 JPEG 格式保存的 HDR 图像的编解码研究。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jackchou.top/tags/code/">Code</a></li>
      <li><a href="https://jackchou.top/tags/hdr/">HDR</a></li>
      <li><a href="https://jackchou.top/tags/gainmap/">Gainmap</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jackchou.top/">🏡JacksBlog</a></span> · 
        my friends&rsquo; websites: <a href="https://zhxwu.com/">zhxwu.com</a>, <a href="https://ylqian.com/">ylqian.com</a> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div style="text-align: center; margin-top: 10px; margin-bottom: 20px; width: 100%; display: flex; justify-content: center;">
    <img src="https://visitor-badge.laobi.icu/badge?page_id=jacksblog" alt="visitors" style="max-width: 120px; height: auto;" />
</div>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
