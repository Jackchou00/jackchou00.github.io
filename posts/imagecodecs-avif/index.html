<!doctype html><html lang=zh-CN dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python AVIF 编码新选择：ImageCodecs | JacksBlog</title>
<meta name=keywords content="Python 图像处理,AVIF 图片编码,imagecodecs AVIF 转换,NumPy 数组 AVIF 导出,libavif Python 绑定,Python 高位深图片编码,Python HDR 图像生成,BT.2020 色彩空间参数"><meta name=description content="关于在 Python 里用数组处理图像、如何更好地编码 AVIF（尤其是高位深/HDR）的快速记录。"><meta name=author content="周淼森"><link rel=canonical href=https://jackchou.top/posts/imagecodecs-avif/><link crossorigin=anonymous href=/assets/css/stylesheet.07f6d388270a92c62af4a6f9c96374ae63b804ca5e22b2e4f3d2e446ce05d1b5.css integrity="sha256-B/bTiCcKksYq9Kb5yWN0rmO4BMpeIrLk89LkRs4F0bU=" rel="preload stylesheet" as=style><link rel=icon href=https://jackchou.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jackchou.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jackchou.top/favicon-32x32.png><link rel=apple-touch-icon href=https://jackchou.top/apple-touch-icon.png><link rel=mask-icon href=https://jackchou.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://jackchou.top/posts/imagecodecs-avif/><link rel=alternate hreflang=en href=https://jackchou.top/en/posts/imagecodecs-avif/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://cdn.jsdelivr.net><meta property="og:url" content="https://jackchou.top/posts/imagecodecs-avif/"><meta property="og:site_name" content="JacksBlog"><meta property="og:title" content="Python AVIF 编码新选择：ImageCodecs"><meta property="og:description" content="关于在 Python 里用数组处理图像、如何更好地编码 AVIF（尤其是高位深/HDR）的快速记录。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-10T23:00:00+08:00"><meta property="article:modified_time" content="2025-11-26T00:04:28+08:00"><meta property="article:tag" content="Display"><meta property="article:tag" content="HDR"><meta property="article:tag" content="AVIF"><meta property="article:tag" content="Image"><meta property="og:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp"><meta name=twitter:title content="Python AVIF 编码新选择：ImageCodecs"><meta name=twitter:description content="关于在 Python 里用数组处理图像、如何更好地编码 AVIF（尤其是高位深/HDR）的快速记录。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章 🌳","item":"https://jackchou.top/posts/"},{"@type":"ListItem","position":2,"name":"Python AVIF 编码新选择：ImageCodecs","item":"https://jackchou.top/posts/imagecodecs-avif/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python AVIF 编码新选择：ImageCodecs","name":"Python AVIF 编码新选择：ImageCodecs","description":"关于在 Python 里用数组处理图像、如何更好地编码 AVIF（尤其是高位深/HDR）的快速记录。","keywords":["Python 图像处理","AVIF 图片编码","imagecodecs AVIF 转换","NumPy 数组 AVIF 导出","libavif Python 绑定","Python 高位深图片编码","Python HDR 图像生成","BT.2020 色彩空间参数"],"articleBody":"前情提要 需求 使用 Python 处理和生成的图片，通常以 NumPy 数组的形式存在，把这个数组输出到文件是处理链路的最后一环。以往，使用最多的是 PIL 编码成 JPEG 格式。而随着 HDR，高位深，高压缩率的需求增加，我开始寻找能将数字直接编码成 AVIF 图像的方法。\nlibavif 和 libheif 几乎所有相关的库都是 libavif 或 libheif 的 Python 绑定，实际上你完全可以先导出一个 JPEG 或者高位深的 TIFF，然后直接调用编译好的 libavif 进行编码，所有参数（质量、速度、颜色配置）都可以传进去。如果你的需求只是压缩图片，那没有必要进入 Python 再绕一圈。\n所以核心需求其实就是找一个好用的 libavif 的 Python 绑定，需要能够支持各种参数传入，如果 API 设计的优雅就更好了\n为数不多的选择 Python 中的 AVIF 编码已经有了一些发展，PIL 在 11.3.0 版本中加入了对 AVIF 的官方支持，但读和写都仅支持 8 bit，也没有传参数的接口，下面的两个插件则可以读写高位深图片和传参数。\n在 PIL 的 11.3.0 版本之前，要使用 PIL 编码 AVIF 的选择是 pillow-avif-plugin 插件，高级参数可以用变长关键字塞进去。\nPIL 的另一个选择是 pillow-heif，它是 libheif 的绑定，在 1.0.0 版本之后，去除了对 AVIF 的支持，开发者给出的理由是 PIL 已经原生支持了 AVIF，最后一个可用 AVIF 的版本是 0.22.0，高级参数同样需要使用变长关键字。\nImageIO 和 OpenImageIO，这两个库都提供了各种图像格式的读写功能，但似乎也不支持高位深和高级参数，（其实是这俩 API 的用法比较复杂，我还没研究明白，但应该是没有或者比较麻烦）。\n新选择：ImageCodecs ImageCodecs 也是一个提供了各种图像格式读写功能的库，AVIF 用的后端是 libavif。\n它的优点是 API 设计的非常简洁，曾经不支持色彩空间参数的传入，在 2025.11.11 版本中加入了支持。（有需求时，请大胆又合理地在 Issue 里“伸手”）\n注意：请手动指定编码速度和线程数量，速度可以参考 libavif 的例程 avifenc 的默认值 6。否则默认参数可能会以单线程和最低速度进行编码，一张 4K 分辨率的图片将会消耗数分钟。\n库中包装了一些参数，也可以使用 int 数字直接传入，基色和传递函数的定义可以在 H.273 中找到。\n另外，使用 10 或 12 bit 时，需要使用 uint16 类型，但不要拉伸。例如一个 10 bit 图像的最大值应为 1023，12 bit 则为 4095。\nfrom imagecodecs import avif_version, avif_encode, AVIF import numpy as np print(AVIF.available) print(avif_version()) array = np.ones((100, 100), dtype=np.uint16) * 1023 # 10-bit, BT.2020 with BT.2100 PQ transfer function encoded: bytes = avif_encode( array, level=AVIF.QUALITY.DEFAULT, # 0-100 speed=AVIF.SPEED.FASTEST, # 0-10 bitspersample=10, primaries=AVIF.COLOR_PRIMARIES.BT2020, transfer=AVIF.TRANSFER_CHARACTERISTICS.PQ, numthreads=8, ) with open(\"output.avif\", \"wb\") as f: f.write(encoded) 它的所有图像格式都采用类似的函数命名，你只需要检查是否可用，版本号，然后 encode 或 decode 即可。\n小心闪光弹（不过可能晚了）\nBT.2020 基色，BT.2100 PQ 传递函数的最大 RGB 及白色，10 bit，由 ImageCodecs 编码。\n","wordCount":"1003","inLanguage":"zh-cn","image":"https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp","datePublished":"2025-11-10T23:00:00+08:00","dateModified":"2025-11-26T00:04:28+08:00","author":{"@type":"Person","name":"周淼森"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jackchou.top/posts/imagecodecs-avif/"},"publisher":{"@type":"Organization","name":"JacksBlog","logo":{"@type":"ImageObject","url":"https://jackchou.top/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jackchou.top/ accesskey=h title="JacksBlog (Alt + H)">JacksBlog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://jackchou.top/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://jackchou.top/posts/ title="文章 🌳"><span>文章 🌳</span></a></li><li><a href=https://jackchou.top/photos/ title="照片 📷"><span>照片 📷</span></a></li><li><a href=https://jackchou.top/tags/ title="标签 🏷️"><span>标签 🏷️</span></a></li><li><a href=https://jackchou.top/about/ title="关于 😼"><span>关于 😼</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Python AVIF 编码新选择：ImageCodecs</h1><div class=post-meta><span title='2025-11-10 23:00:00 +0800 +0800'>2025.11.10</span>&nbsp;|&nbsp;更多语言:<ul class=i18n_list><li><a href=https://jackchou.top/en/posts/imagecodecs-avif/>English</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e6%83%85%e6%8f%90%e8%a6%81 aria-label=前情提要>前情提要</a><ul><li><a href=#%e9%9c%80%e6%b1%82 aria-label=需求>需求</a></li><li><a href=#libavif-%e5%92%8c-libheif aria-label="libavif 和 libheif">libavif 和 libheif</a></li></ul></li><li><a href=#%e4%b8%ba%e6%95%b0%e4%b8%8d%e5%a4%9a%e7%9a%84%e9%80%89%e6%8b%a9 aria-label=为数不多的选择>为数不多的选择</a></li><li><a href=#%e6%96%b0%e9%80%89%e6%8b%a9imagecodecs aria-label=新选择：ImageCodecs>新选择：ImageCodecs</a></li></ul></div></details></div><div class=post-content><h2 id=前情提要>前情提要<a hidden class=anchor aria-hidden=true href=#前情提要>#</a></h2><h3 id=需求>需求<a hidden class=anchor aria-hidden=true href=#需求>#</a></h3><p>使用 Python 处理和生成的图片，通常以 NumPy 数组的形式存在，把这个数组输出到文件是处理链路的最后一环。以往，使用最多的是 PIL 编码成 JPEG 格式。而随着 HDR，高位深，高压缩率的需求增加，我开始寻找能将数字直接编码成 AVIF 图像的方法。</p><h3 id=libavif-和-libheif>libavif 和 libheif<a hidden class=anchor aria-hidden=true href=#libavif-和-libheif>#</a></h3><p>几乎所有相关的库都是 libavif 或 libheif 的 Python 绑定，实际上你完全可以先导出一个 JPEG 或者高位深的 TIFF，然后直接调用编译好的 libavif 进行编码，所有参数（质量、速度、颜色配置）都可以传进去。如果你的需求只是压缩图片，那没有必要进入 Python 再绕一圈。</p><p><strong>所以核心需求其实就是找一个好用的 libavif 的 Python 绑定，需要能够支持各种参数传入，如果 API 设计的优雅就更好了</strong></p><h2 id=为数不多的选择>为数不多的选择<a hidden class=anchor aria-hidden=true href=#为数不多的选择>#</a></h2><p>Python 中的 AVIF 编码已经有了一些发展，PIL 在 11.3.0 版本中加入了对 AVIF 的官方支持，但读和写都仅支持 8 bit，也没有传参数的接口，下面的两个插件则可以读写高位深图片和传参数。</p><p>在 PIL 的 11.3.0 版本之前，要使用 PIL 编码 AVIF 的选择是 <code>pillow-avif-plugin</code> 插件，高级参数可以用变长关键字塞进去。</p><p>PIL 的另一个选择是 <code>pillow-heif</code>，它是 libheif 的绑定，在 1.0.0 版本之后，去除了对 AVIF 的支持，开发者给出的理由是 PIL 已经原生支持了 AVIF，最后一个可用 AVIF 的版本是 0.22.0，高级参数同样需要使用变长关键字。</p><p>ImageIO 和 OpenImageIO，这两个库都提供了各种图像格式的读写功能，但似乎也不支持高位深和高级参数，（其实是这俩 API 的用法比较复杂，我还没研究明白，但应该是没有或者比较麻烦）。</p><h2 id=新选择imagecodecs>新选择：ImageCodecs<a hidden class=anchor aria-hidden=true href=#新选择imagecodecs>#</a></h2><p><a href=https://github.com/cgohlke/imagecodecs>ImageCodecs</a> 也是一个提供了各种图像格式读写功能的库，AVIF 用的后端是 libavif。</p><p>它的优点是 API 设计的非常简洁，曾经不支持色彩空间参数的传入，在 2025.11.11 版本中加入了支持。（有需求时，请大胆又合理地在 <a href=https://github.com/cgohlke/imagecodecs/issues/131>Issue</a> 里“伸手”）</p><p>注意：请手动指定编码速度和线程数量，速度可以参考 <code>libavif</code> 的例程 <code>avifenc</code> 的默认值 6。否则默认参数可能会以单线程和最低速度进行编码，一张 4K 分辨率的图片将会消耗数分钟。</p><p>库中包装了一些参数，也可以使用 <code>int</code> 数字直接传入，基色和传递函数的定义可以在 H.273 中找到。</p><p>另外，使用 10 或 12 bit 时，需要使用 <code>uint16</code> 类型，但不要拉伸。例如一个 10 bit 图像的最大值应为 1023，12 bit 则为 4095。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> imagecodecs <span style=color:#f92672>import</span> avif_version, avif_encode, AVIF
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(AVIF<span style=color:#f92672>.</span>available)
</span></span><span style=display:flex><span>print(avif_version())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>array <span style=color:#f92672>=</span> np<span style=color:#f92672>.</span>ones((<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>100</span>), dtype<span style=color:#f92672>=</span>np<span style=color:#f92672>.</span>uint16) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1023</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 10-bit, BT.2020 with BT.2100 PQ transfer function</span>
</span></span><span style=display:flex><span>encoded: bytes <span style=color:#f92672>=</span> avif_encode(
</span></span><span style=display:flex><span>    array,
</span></span><span style=display:flex><span>    level<span style=color:#f92672>=</span>AVIF<span style=color:#f92672>.</span>QUALITY<span style=color:#f92672>.</span>DEFAULT, <span style=color:#75715e># 0-100</span>
</span></span><span style=display:flex><span>    speed<span style=color:#f92672>=</span>AVIF<span style=color:#f92672>.</span>SPEED<span style=color:#f92672>.</span>FASTEST,   <span style=color:#75715e># 0-10</span>
</span></span><span style=display:flex><span>    bitspersample<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>    primaries<span style=color:#f92672>=</span>AVIF<span style=color:#f92672>.</span>COLOR_PRIMARIES<span style=color:#f92672>.</span>BT2020,
</span></span><span style=display:flex><span>    transfer<span style=color:#f92672>=</span>AVIF<span style=color:#f92672>.</span>TRANSFER_CHARACTERISTICS<span style=color:#f92672>.</span>PQ,
</span></span><span style=display:flex><span>    numthreads<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;output.avif&#34;</span>, <span style=color:#e6db74>&#34;wb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    f<span style=color:#f92672>.</span>write(encoded)
</span></span></code></pre></div><p>它的所有图像格式都采用类似的函数命名，你只需要检查是否可用，版本号，然后 encode 或 decode 即可。</p><p>小心闪光弹（不过可能晚了）</p><p><img alt="bt2020 pq test by imagecodecs" loading=lazy src=https://img.jackchou.top/jack-img/2025/11/7e50ba86eb4697f2055b7b5b0763cca9.avif></p><p>BT.2020 基色，BT.2100 PQ 传递函数的最大 RGB 及白色，10 bit，由 ImageCodecs 编码。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jackchou.top/tags/display/>Display</a></li><li><a href=https://jackchou.top/tags/hdr/>HDR</a></li><li><a href=https://jackchou.top/tags/avif/>AVIF</a></li><li><a href=https://jackchou.top/tags/image/>Image</a></li></ul><nav class=paginav><a class=prev href=https://jackchou.top/photos/matchbox-h7s-lite-roaster/><span class=title>« 上一篇</span><br><span>一颗生豆的艺术之旅，自己动手烘咖啡</span>
</a><a class=next href=https://jackchou.top/posts/cic33-paper/><span class=title>下一篇 »</span><br><span>(Temp) CIC 33 Paper Demonstration</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://jackchou.top/>JacksBlog</a></span> ·
my friends&rsquo; websites: <a href=https://zhxwu.com/>zhxwu.com</a>, <a href=https://ylqian.com/>ylqian.com</a> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script defer crossorigin=anonymous src=/js/site.min.a576538c52b362e170acc02d53f5ce6045117863354954a8f91f10c7217d94ab.js integrity="sha256-pXZTjFKzYuFwrMAtU/XOYEUReGM1SVSo+R8QxyF9lKs="></script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="拷贝";function s(){t.innerHTML="已拷贝",setTimeout(()=>{t.innerHTML="拷贝"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>