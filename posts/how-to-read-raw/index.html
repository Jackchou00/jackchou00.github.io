<!DOCTYPE html>
<html lang="zh-CN"
    dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>如何正确读取 RAW 文件 | JacksBlog</title>
<meta name="keywords" content="RAW 数据读取, 相机 RAW 格式解码, Rawpy 提取 RAW 像素, dcraw 格式转换工具, Sony 无损压缩 RAW 解析, Capture One DNG 转换误差, 哈苏 3FR 黑电平校正, Canon CR3 光学黑场">
<meta name="description" content="本文对比了处理 RAW 数据的各类工具，包括 dcraw 和 Rawpy/Libraw 的使用方法及其对索尼、佳能、哈苏、富士等相机无损压缩与无压缩 RAW 文件的解码差异，并给出读取 RAW 图像数据的最佳实践建议。">
<meta name="author" content="周淼森">
<link rel="canonical" href="https://jackchou.top/posts/how-to-read-raw/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.86974c6b2de41d4687d60a6ae9cd208741bff58a4d161369ffea23f2f3244458.css" integrity="sha256-hpdMay3kHUaH1gpq6c0gh0G/9YpNFhNp/&#43;oj8vMkRFg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jackchou.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jackchou.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jackchou.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jackchou.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://jackchou.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="https://jackchou.top/posts/how-to-read-raw/">
<link rel="alternate" hreflang="en" href="https://jackchou.top/en/posts/how-to-read-raw/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Google&#43;Sans&#43;Code:wght@400..700&amp;family=Noto&#43;Sans&#43;SC:wght@400..700&amp;family=Sen:wght@400..700&amp;display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google&#43;Sans&#43;Code:wght@400..700&amp;family=Noto&#43;Sans&#43;SC:wght@400..700&amp;family=Sen:wght@400..700&amp;display=swap" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google&#43;Sans&#43;Code:wght@400..700&amp;family=Noto&#43;Sans&#43;SC:wght@400..700&amp;family=Sen:wght@400..700&amp;display=swap"></noscript>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-6YGE0Y6TC7"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-6YGE0Y6TC7');
        }
      </script><meta property="og:url" content="https://jackchou.top/posts/how-to-read-raw/">
  <meta property="og:site_name" content="JacksBlog">
  <meta property="og:title" content="如何正确读取 RAW 文件">
  <meta property="og:description" content="本文对比了处理 RAW 数据的各类工具，包括 dcraw 和 Rawpy/Libraw 的使用方法及其对索尼、佳能、哈苏、富士等相机无损压缩与无压缩 RAW 文件的解码差异，并给出读取 RAW 图像数据的最佳实践建议。">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-28T00:00:00+08:00">
    <meta property="article:modified_time" content="2025-12-14T21:46:53+08:00">
    <meta property="article:tag" content="Colour">
    <meta property="article:tag" content="ISP">
      <meta property="og:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp">
<meta name="twitter:title" content="如何正确读取 RAW 文件">
<meta name="twitter:description" content="本文对比了处理 RAW 数据的各类工具，包括 dcraw 和 Rawpy/Libraw 的使用方法及其对索尼、佳能、哈苏、富士等相机无损压缩与无压缩 RAW 文件的解码差异，并给出读取 RAW 图像数据的最佳实践建议。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "文章 🌳",
      "item": "https://jackchou.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "如何正确读取 RAW 文件",
      "item": "https://jackchou.top/posts/how-to-read-raw/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "如何正确读取 RAW 文件",
  "name": "如何正确读取 RAW 文件",
  "description": "本文对比了处理 RAW 数据的各类工具，包括 dcraw 和 Rawpy/Libraw 的使用方法及其对索尼、佳能、哈苏、富士等相机无损压缩与无压缩 RAW 文件的解码差异，并给出读取 RAW 图像数据的最佳实践建议。",
  "keywords": [
    "RAW 数据读取", "相机 RAW 格式解码", "Rawpy 提取 RAW 像素", "dcraw 格式转换工具", "Sony 无损压缩 RAW 解析", "Capture One DNG 转换误差", "哈苏 3FR 黑电平校正", "Canon CR3 光学黑场"
  ],
  "articleBody": "旋转图像 以下内容中，都假设图像以横向拍摄。如果需要匹配竖拍的图像，需要进行旋转，可以从 EXIF 中读取 Orientation 标签来决定旋转的角度。比如说使用 Python 的 exifread 库：\nwith open(image_path, 'rb') as f: tags = exifread.process_file(f) orientation = tags.get('Image Orientation', 'Unknown') print(f\"Image Orientation: {orientation}\") # e.g. Rotated 90 CCW 读取 RAW 数据的工具 Dcraw 最著名的读取 raw 数据的工具莫过于 dcraw。Dcraw 能够将各种编码方式的 raw 文件转换成 TIFF 或 PPM 格式。\n使用命令行 dcraw -4 -T -D file_name 就能够获得一个 16 bit 的 TIFF 文件，记录了 raw 的直接数值，没有经过包括解拜尔、白平衡、扣除黑电平在内的操作。\n遗憾的是，dcraw 的最后一次更新是 2018 年 6 月 1 日。因此之后相机的附加参数（白平衡，颜色矩阵等）不再包含，仅用于提取 raw 数据的功能也不一定能够正常使用。\n比如说：对于索尼在四代机（ILCE-7M4）中加入的无损压缩 RAW 格式，虽然后缀名都是 arw，但 dcraw 会报 cannot decode file 的错误，而和之前一样的无压缩 RAW 是可以解的。\ndcraw.c 是 dcraw 的核心文件，由一万多行纯 c 语言完成。\nRawpy/Libraw Rawpy 是 libraw 的 python warpper。Libraw 提供了访问 raw 数据的统一接口，用于提取像素值，它基于 dcraw，将 dcraw.c 重构为更现代和模块化的库，并在 dcraw 停止维护后继续支持。\n各方法和品牌的差别 Sony 无压缩 RAW 在更新的机器上（应该是 ZVE-10 II 之后的机型），索尼不再提供无压缩 RAW 选项。\n测试机型是 ILCE-7 CM2：\n以下方式读取的无压缩 RAW 结果是一样的：\nDcraw 转 tiff 后用 openimageio 读取 直接用 rawpy 读取 用 adobe DNG converter 转换后用 rawpy 读取 用 adobe camera raw 转换后用 rawpy 读取（同上，虽然在 acr 中查看尺寸时不同） 用 adobe DNG converter 转换后，用 dcraw 转 tiff 再用 oiio 读取 以上方法读出的尺寸都是 (4688, 7040)，总之就是怎么读都一样，毕竟它无压缩嘛。\n实际上，用 adobe dng converter 和 adobe camera raw 转换的 dng 是完全一样的，以下不再赘述。用 Rawpy 和 dcraw 读取 dng 也是等效的。\n无损压缩 RAW 索尼的无损压缩 RAW 原理是先补 0 到长宽为 512 的倍数，然后分块，再按照 Bayer 分四个子图进行差分编码和霍夫曼编码。\n对于无损压缩 RAW 来说，情况比较复杂，因为目前没有办法在无压缩的 ARW 和无损压缩的 ARW 间转换。以下是经过测试的情况：\nDcraw 不支持无损压缩 RAW（因为索尼引入无损压缩 RAW 时 dcraw 已不再更新）。 Rawpy 读取 ARW，得到的是 (5120, 7168) 尺寸，这是由于分块压缩导致的（512 的倍数），只有左上角 (4688, 7040) 区域有内容，剩下的是 0（而不是黑电平），数值是 0-16383。 用 adobe DNG converter 转换成 dng 后用 rawpy 读取，得到的尺寸是 (4686, 7038)，比无压缩 RAW 等少两个像素。上一种情况中再去掉底部和右边各 2 像素，可以完全匹配，也是 0-16383。 压缩 RAW：Compressed HQ 曾经，索尼的有损压缩 RAW 格式因为太过垃圾而臭名昭著。到了 a7M5 上，终于推出了改进的有损压缩模式：Compressed HQ，应当具有更平衡的画质和体积。目前是只有索尼自己的 IEDT 能解码该格式，等第三方软件更新后，再来仔细品鉴。\n关于 Capture One 等其它软件的 DNG 理论上，一个解码 RAW 并编码到 DNG 的编解码器不会带来太复杂的误差。但 Capture One 导出的 DNG 不仅尺寸有区别，还会将原本 14 bit 的数据拉伸到 16 bit，且不能与其它方法读的 raw 完全匹配。\n在 Gemini 和 DeepSeek 的帮助下，进行了一些更细致的分析。关于如何从 14 bit 到 16 bit，Capture One 进行的应该是左移两位，即直接 *4。将 rawpy 读取的 arw 左移后与 C1 导出的 dng 相除与相减，得到的商为 1.000004，差也是 e-7 的数量级。其中，R 和 B 通道是完全匹配的，误差全部来自两个 G 通道，而且和图像内容有关，个别图像中，G 的最大误差甚至能达到 10%，多数情况下，最大误差不超过 5%。\nDNG 作为一个有规范要求的文件格式，不应该对 RAW 数据本身做处理，因此不推荐用 Adobe 以外的软件来转换 RAW 图像格式到 DNG。\nSony RAW 的最佳实践 综上，最推荐的 Sony RAW 使用方法是拍摄无压缩的 RAW 之后直接用 Rawpy 读取，用 dng converter 可以方便的把无压缩 RAW 转换成无损压缩的 DNG 来减少体积，同时不会有任何损失，或是无损压缩 RAW 用 Rawpy 读取并做裁切，但注意无损压缩 RAW 转换成 DNG 时会损失两行两列像素。\nCanon 测试机型是从一个数据集里拿的 600D，输出的是 CR2。\n用 rawpy 和转成 dng 之后读取是一致的，图像尺寸是 (3516, 5344)，左边 142 像素和上方 51 像素应该是光学黑场（被物理遮盖用于黑电平校正的部分），能读出近似黑电平的数值，剩余部分是图像。\nDcraw 是可以处理 600D 的，读出的是没有光学黑场的部分，这一部分和裁切后的 rawpy 或 dng 匹配。\nR6 Mark II 输出的 CR3 （用 rawpy 或转成 dng 读取）也类似，左侧 154 个像素、顶部 96 个像素是光学黑场，另外右侧还有 8 个像素的白色区域。\n到了 R6 Mark III，似乎就没有光学黑场了，读出的全部是图像内容。不得不说 CR3 格式确实非常先进，无损压缩的同时，压缩率也非常高。\nHasselblad 测试机型为哈苏 X2D-100C，相机直接输出 3FR 格式的 RAW 文件。其传感器型号可从 3FR 文件中直接确认，为索尼 IMX461-BQR。\n哈苏的 RAW 工作流历史上涉及 3FR 和 FFF 两种文件格式。\n随着新版 Phocus 的发布，FFF 文件已被移出 RAW 工作流，现在无需先转换到 FFF 再处理 RAW 图像。\n在旧版流程中，用户可以通过 Phocus 软件将 3FR 转换为 FFF。转换时有一些可选的调整选项，但这不影响 FFF 文件本身的原始数据（例如，使用 rawpy 读取的结果都相同）。从文件头可以发现，3FR (49 49 2A 00) 遵循小端序 TIFF 规范，而 FFF (4D 4D 00 2A) 则是大端序 TIFF。\nIMX461-BQR 的公开规格显示，其总像素为 11760×8896，有效像素为 11664×8750。然而，使用 dcraw 或 rawpy 等工具直接解析 3FR 文件，会得到一个 11904×8842 的超大图像。这个图像包含了以下几个区域：\n图像内容区： 尺寸为 11664×8750，与 461 的有效像素一致。 光学黑场 (Optical Black)： 包围在图像内容区外，左右各 48px，上方 90px。 额外内容： 在最外围，包含左侧 76px、右侧 68px 和上方 2px 的非图像数据。 分析可知，包含光学黑场在内的图像宽度为 11760px（与传感器总像素宽度吻合），但高度为 8840px，略有出入。\n无论是 3FR 还是 FFF，都可以转换为 DNG 格式，转换后的 DNG 文件尺寸会裁切到与有效像素区一致，内容上，虽然画面内容能够对齐，但数值上有一些小区别。\n所以目前来看，处理哈苏 3FR 文件的最佳实践是直接使用 libraw 读取，提取出有效的图像区域，并利用图像中的光学黑场数据进行精确的黑电平校正。\nFujifilm 测试机型是 X-T5。\n富士的 raw 比较特殊，因为其表面的滤色片不是普通的拜尔排列，而是 X-Trans，最小重复单元是 6 行 6 列。好在不影响我们分析 raw 图像本身。\n把 RAF 直接输入 rawpy，得到的图像长 7872，高 5196，转换成 DNG 后，长 7728，高 5152。多出来的长 44 个像素，高 144 个像素具体分布是：\n左侧 12 个有画面的像素，右侧 12 个有画面的像素和 120 个黑。 顶部 16 个有画面的像素和 5 个黑，底部 16 画面 7 黑。 重叠部分的像素值是完全一样的。\n另外，rawpy 读取 raf 的 raw pattern 有错误，dng 中的 raw pattern 是正确的。\n需要提醒的是，libraw 提供了一个名为 halfsize 的选项，在 Bayer 传感器上，可以讲 RGGB 合并成一个像素，输出一个半分辨率的三通道图像，理论上来说，该选项不应对 X-Trans 传感器使用，但在 libraw 中仍然可以开启，似乎会走和 Bayer 一样的管线，产生错误的结果。\nNikon 尼康的情况最为简单，测试机型是 Z6，输出的是 NEF 文件。直接用 libraw 读取或者转成 dng 读取，得到的图像尺寸都是 (6064, 4040)，除了图像没有多余的区域，内容也完全一样。\n总结 通常来说，最方便的做法总是转换成 DNG，这样既缩小了文件体积，又统一了格式，还裁切掉了各种图像以外的区域，便于后续处理。如果希望保留原始格式，元数据和被裁切的区域，则可以用 libraw 或 rawpy 直接读取原始 RAW 文件。经过各种测试，在绝大多数情况下，重合的图像区域里，像素值是完全一致的。\n不推荐使用 Adobe 以外的软件来转换 RAW 到 DNG。Dcraw 由于停止维护，推荐迁移至 libraw/rawpy。\n",
  "wordCount" : "3018",
  "inLanguage": "zh-cn",
  "image": "https://img.jackchou.top/jack-img/2025/08/81bb602c03f9704ee42e292468396187.webp","datePublished": "2025-03-28T00:00:00+08:00",
  "dateModified": "2025-12-14T21:46:53+08:00",
  "author":{
    "@type": "Person",
    "name": "周淼森"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jackchou.top/posts/how-to-read-raw/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "JacksBlog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jackchou.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jackchou.top/" accesskey="h" title="JacksBlog (Alt + H)">JacksBlog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://jackchou.top/en/" title="English"
                            aria-label="English">English</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jackchou.top/posts/" title="文章 🌳">
                    <span>文章 🌳</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/photos/" title="照片 📷">
                    <span>照片 📷</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/tags/" title="标签 🏷️">
                    <span>标签 🏷️</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/about/" title="关于 😼">
                    <span>关于 😼</span>
                </a>
            </li>
            <li>
                <a href="https://jackchou.top/search/" title="🔍">
                    <span>🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      如何正确读取 RAW 文件
    </h1>
    
    <div class="post-meta"><span title='2025-03-28 00:00:00 +0800 +0800'>2025.03.28</span>&nbsp;|&nbsp;更多语言:
<ul class="i18n_list">
    <li>
        <a href="https://jackchou.top/en/posts/how-to-read-raw/">English</a>
    </li>
</ul>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%97%8b%e8%bd%ac%e5%9b%be%e5%83%8f" aria-label="旋转图像">旋转图像</a></li>
                <li>
                    <a href="#%e8%af%bb%e5%8f%96-raw-%e6%95%b0%e6%8d%ae%e7%9a%84%e5%b7%a5%e5%85%b7" aria-label="读取 RAW 数据的工具">读取 RAW 数据的工具</a><ul>
                        
                <li>
                    <a href="#dcraw" aria-label="Dcraw">Dcraw</a></li>
                <li>
                    <a href="#rawpylibraw" aria-label="Rawpy/Libraw">Rawpy/Libraw</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%84%e6%96%b9%e6%b3%95%e5%92%8c%e5%93%81%e7%89%8c%e7%9a%84%e5%b7%ae%e5%88%ab" aria-label="各方法和品牌的差别">各方法和品牌的差别</a><ul>
                        
                <li>
                    <a href="#sony" aria-label="Sony">Sony</a><ul>
                        
                <li>
                    <a href="#%e6%97%a0%e5%8e%8b%e7%bc%a9-raw" aria-label="无压缩 RAW">无压缩 RAW</a></li>
                <li>
                    <a href="#%e6%97%a0%e6%8d%9f%e5%8e%8b%e7%bc%a9-raw" aria-label="无损压缩 RAW">无损压缩 RAW</a></li>
                <li>
                    <a href="#%e5%8e%8b%e7%bc%a9-rawcompressed-hq" aria-label="压缩 RAW：Compressed HQ">压缩 RAW：Compressed HQ</a></li>
                <li>
                    <a href="#%e5%85%b3%e4%ba%8e-capture-one-%e7%ad%89%e5%85%b6%e5%ae%83%e8%bd%af%e4%bb%b6%e7%9a%84-dng" aria-label="关于 Capture One 等其它软件的 DNG">关于 Capture One 等其它软件的 DNG</a></li>
                <li>
                    <a href="#sony-raw-%e7%9a%84%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" aria-label="Sony RAW 的最佳实践">Sony RAW 的最佳实践</a></li></ul>
                </li>
                <li>
                    <a href="#canon" aria-label="Canon">Canon</a></li>
                <li>
                    <a href="#hasselblad" aria-label="Hasselblad">Hasselblad</a></li>
                <li>
                    <a href="#fujifilm" aria-label="Fujifilm">Fujifilm</a></li>
                <li>
                    <a href="#nikon" aria-label="Nikon">Nikon</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="旋转图像">旋转图像<a hidden class="anchor" aria-hidden="true" href="#旋转图像">#</a></h2>
<p>以下内容中，都假设图像以横向拍摄。如果需要匹配竖拍的图像，需要进行旋转，可以从 EXIF 中读取 <code>Orientation</code> 标签来决定旋转的角度。比如说使用 Python 的 <code>exifread</code> 库：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(image_path, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    tags <span style="color:#f92672">=</span> exifread<span style="color:#f92672">.</span>process_file(f)
</span></span><span style="display:flex;"><span>    orientation <span style="color:#f92672">=</span> tags<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;Image Orientation&#39;</span>, <span style="color:#e6db74">&#39;Unknown&#39;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Image Orientation: </span><span style="color:#e6db74">{</span>orientation<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># e.g. Rotated 90 CCW</span>
</span></span></code></pre></div><h2 id="读取-raw-数据的工具">读取 RAW 数据的工具<a hidden class="anchor" aria-hidden="true" href="#读取-raw-数据的工具">#</a></h2>
<h3 id="dcraw">Dcraw<a hidden class="anchor" aria-hidden="true" href="#dcraw">#</a></h3>
<p>最著名的读取 raw 数据的工具莫过于 dcraw。Dcraw 能够将各种编码方式的 raw 文件转换成 TIFF 或 PPM 格式。</p>
<p>使用命令行 <code>dcraw -4 -T -D file_name</code> 就能够获得一个 16 bit 的 TIFF 文件，记录了 raw 的直接数值，没有经过包括解拜尔、白平衡、扣除黑电平在内的操作。</p>
<p>遗憾的是，dcraw 的最后一次更新是 2018 年 6 月 1 日。因此之后相机的附加参数（白平衡，颜色矩阵等）不再包含，仅用于提取 raw 数据的功能也不一定能够正常使用。</p>
<p>比如说：对于索尼在四代机（ILCE-7M4）中加入的无损压缩 RAW 格式，虽然后缀名都是 arw，但 dcraw 会报 cannot decode file 的错误，而和之前一样的无压缩 RAW 是可以解的。</p>
<p><code>dcraw.c</code> 是 dcraw 的核心文件，由一万多行纯 c 语言完成。</p>
<h3 id="rawpylibraw">Rawpy/Libraw<a hidden class="anchor" aria-hidden="true" href="#rawpylibraw">#</a></h3>
<p>Rawpy 是 libraw 的 python warpper。Libraw 提供了访问 raw 数据的统一接口，用于提取像素值，它基于 dcraw，将 <code>dcraw.c</code> 重构为更现代和模块化的库，并在 dcraw 停止维护后继续支持。</p>
<h2 id="各方法和品牌的差别">各方法和品牌的差别<a hidden class="anchor" aria-hidden="true" href="#各方法和品牌的差别">#</a></h2>
<h3 id="sony">Sony<a hidden class="anchor" aria-hidden="true" href="#sony">#</a></h3>
<h4 id="无压缩-raw">无压缩 RAW<a hidden class="anchor" aria-hidden="true" href="#无压缩-raw">#</a></h4>
<blockquote>
<p>在更新的机器上（应该是 ZVE-10 II 之后的机型），索尼不再提供无压缩 RAW 选项。</p>
</blockquote>
<p>测试机型是 ILCE-7 CM2：</p>
<p>以下方式读取的无压缩 RAW 结果是一样的：</p>
<ul>
<li>Dcraw 转 tiff 后用 openimageio 读取</li>
<li>直接用 rawpy 读取</li>
<li>用 adobe DNG converter 转换后用 rawpy 读取</li>
<li>用 adobe camera raw 转换后用 rawpy 读取（同上，虽然在 acr 中查看尺寸时不同）</li>
<li>用 adobe DNG converter 转换后，用 dcraw 转 tiff 再用 oiio 读取</li>
</ul>
<p>以上方法读出的尺寸都是 (4688, 7040)，总之就是怎么读都一样，毕竟它无压缩嘛。</p>
<p>实际上，用 adobe dng converter 和 adobe camera raw 转换的 dng 是完全一样的，以下不再赘述。用 Rawpy 和 dcraw 读取 dng 也是等效的。</p>
<h4 id="无损压缩-raw">无损压缩 RAW<a hidden class="anchor" aria-hidden="true" href="#无损压缩-raw">#</a></h4>
<p>索尼的无损压缩 RAW 原理是先补 0 到长宽为 512 的倍数，然后分块，再按照 Bayer 分四个子图进行差分编码和霍夫曼编码。</p>
<p>对于无损压缩 RAW 来说，情况比较复杂，因为目前没有办法在无压缩的 ARW 和无损压缩的 ARW 间转换。以下是经过测试的情况：</p>
<ul>
<li>Dcraw 不支持无损压缩 RAW（因为索尼引入无损压缩 RAW 时 dcraw 已不再更新）。</li>
<li>Rawpy 读取 ARW，得到的是 (5120, 7168) 尺寸，这是由于分块压缩导致的（512 的倍数），只有左上角 (4688, 7040) 区域有内容，剩下的是 0（而不是黑电平），数值是 0-16383。</li>
<li>用 adobe DNG converter 转换成 dng 后用 rawpy 读取，得到的尺寸是 (4686, 7038)，比无压缩 RAW 等少两个像素。上一种情况中再去掉底部和右边各 2 像素，可以完全匹配，也是 0-16383。</li>
</ul>
<h4 id="压缩-rawcompressed-hq">压缩 RAW：Compressed HQ<a hidden class="anchor" aria-hidden="true" href="#压缩-rawcompressed-hq">#</a></h4>
<p>曾经，索尼的有损压缩 RAW 格式因为太过垃圾而臭名昭著。到了 a7M5 上，终于推出了改进的有损压缩模式：Compressed HQ，应当具有更平衡的画质和体积。目前是只有索尼自己的 IEDT 能解码该格式，等第三方软件更新后，再来仔细品鉴。</p>
<h4 id="关于-capture-one-等其它软件的-dng">关于 Capture One 等其它软件的 DNG<a hidden class="anchor" aria-hidden="true" href="#关于-capture-one-等其它软件的-dng">#</a></h4>
<p>理论上，一个解码 RAW 并编码到 DNG 的编解码器不会带来太复杂的误差。但 Capture One 导出的 DNG 不仅尺寸有区别，还会将原本 14 bit 的数据拉伸到 16 bit，且不能与其它方法读的 raw 完全匹配。</p>
<p>在 Gemini 和 DeepSeek 的帮助下，进行了一些更细致的分析。关于如何从 14 bit 到 16 bit，Capture One 进行的应该是左移两位，即直接 <code>*4</code>。将 rawpy 读取的 arw 左移后与 C1 导出的 dng 相除与相减，得到的商为 1.000004，差也是 e-7 的数量级。其中，R 和 B 通道是完全匹配的，误差全部来自两个 G 通道，<strong>而且和图像内容有关</strong>，个别图像中，G 的最大误差甚至能达到 10%，多数情况下，最大误差不超过 5%。</p>
<p>DNG 作为一个有规范要求的文件格式，不应该对 RAW 数据本身做处理，因此不推荐用 Adobe 以外的软件来转换 RAW 图像格式到 DNG。</p>
<h4 id="sony-raw-的最佳实践">Sony RAW 的最佳实践<a hidden class="anchor" aria-hidden="true" href="#sony-raw-的最佳实践">#</a></h4>
<p>综上，最推荐的 Sony RAW 使用方法是拍摄无压缩的 RAW 之后直接用 Rawpy 读取，用 dng converter 可以方便的把无压缩 RAW 转换成无损压缩的 DNG 来减少体积，同时不会有任何损失，或是无损压缩 RAW 用 Rawpy 读取并做裁切，但注意无损压缩 RAW 转换成 DNG 时会损失两行两列像素。</p>
<h3 id="canon">Canon<a hidden class="anchor" aria-hidden="true" href="#canon">#</a></h3>
<p>测试机型是从一个数据集里拿的 600D，输出的是 CR2。</p>
<p>用 rawpy 和转成 dng 之后读取是一致的，图像尺寸是 (3516, 5344)，左边 142 像素和上方 51 像素应该是光学黑场（被物理遮盖用于黑电平校正的部分），能读出近似黑电平的数值，剩余部分是图像。</p>
<p>Dcraw 是可以处理 600D 的，读出的是没有光学黑场的部分，这一部分和裁切后的 rawpy 或 dng 匹配。</p>
<p>R6 Mark II 输出的 CR3 （用 rawpy 或转成 dng 读取）也类似，左侧 154 个像素、顶部 96 个像素是光学黑场，另外右侧还有 8 个像素的白色区域。</p>
<p>到了 R6 Mark III，似乎就没有光学黑场了，读出的全部是图像内容。不得不说 CR3 格式确实非常先进，无损压缩的同时，压缩率也非常高。</p>
<h3 id="hasselblad">Hasselblad<a hidden class="anchor" aria-hidden="true" href="#hasselblad">#</a></h3>
<p>测试机型为哈苏 X2D-100C，相机直接输出 3FR 格式的 RAW 文件。其传感器型号可从 3FR 文件中直接确认，为索尼 IMX461-BQR。</p>
<p>哈苏的 RAW 工作流历史上涉及 3FR 和 FFF 两种文件格式。</p>
<blockquote>
<p>随着新版 Phocus 的发布，FFF 文件已被移出 RAW 工作流，现在无需先转换到 FFF 再处理 RAW 图像。</p>
</blockquote>
<p>在旧版流程中，用户可以通过 Phocus 软件将 3FR 转换为 FFF。转换时有一些可选的调整选项，但这不影响 FFF 文件本身的原始数据（例如，使用 rawpy 读取的结果都相同）。从文件头可以发现，3FR (<code>49 49 2A 00</code>) 遵循小端序 TIFF 规范，而 FFF (<code>4D 4D 00 2A</code>) 则是大端序 TIFF。</p>
<p>IMX461-BQR 的公开规格显示，其总像素为 11760×8896，有效像素为 11664×8750。然而，使用 dcraw 或 rawpy 等工具直接解析 3FR 文件，会得到一个 11904×8842 的超大图像。这个图像包含了以下几个区域：</p>
<ul>
<li>图像内容区： 尺寸为 11664×8750，与 461 的有效像素一致。</li>
<li>光学黑场 (Optical Black)： 包围在图像内容区外，左右各 48px，上方 90px。</li>
<li>额外内容： 在最外围，包含左侧 76px、右侧 68px 和上方 2px 的非图像数据。</li>
</ul>
<p>分析可知，包含光学黑场在内的图像宽度为 11760px（与传感器总像素宽度吻合），但高度为 8840px，略有出入。</p>
<p>无论是 3FR 还是 FFF，都可以转换为 DNG 格式，转换后的 DNG 文件尺寸会裁切到与有效像素区一致，内容上，虽然画面内容能够对齐，但数值上有一些小区别。</p>
<p>所以目前来看，处理哈苏 3FR 文件的最佳实践是直接使用 libraw 读取，提取出有效的图像区域，并利用图像中的光学黑场数据进行精确的黑电平校正。</p>
<h3 id="fujifilm">Fujifilm<a hidden class="anchor" aria-hidden="true" href="#fujifilm">#</a></h3>
<p>测试机型是 X-T5。</p>
<p>富士的 raw 比较特殊，因为其表面的滤色片不是普通的拜尔排列，而是 X-Trans，最小重复单元是 6 行 6 列。好在不影响我们分析 raw 图像本身。</p>
<p>把 RAF 直接输入 rawpy，得到的图像长 7872，高 5196，转换成 DNG 后，长 7728，高 5152。多出来的长 44 个像素，高 144 个像素具体分布是：</p>
<ul>
<li>左侧 12 个有画面的像素，右侧 12 个有画面的像素和 120 个黑。</li>
<li>顶部 16 个有画面的像素和 5 个黑，底部 16 画面 7 黑。</li>
</ul>
<p>重叠部分的像素值是完全一样的。</p>
<p>另外，rawpy 读取 raf 的 <code>raw pattern</code> 有错误，dng 中的 <code>raw pattern</code> 是正确的。</p>
<p>需要提醒的是，libraw 提供了一个名为 <code>halfsize</code> 的选项，在 Bayer 传感器上，可以讲 RGGB 合并成一个像素，输出一个半分辨率的三通道图像，理论上来说，该选项不应对 X-Trans 传感器使用，但在 libraw 中仍然可以开启，似乎会走和 Bayer 一样的管线，产生错误的结果。</p>
<h3 id="nikon">Nikon<a hidden class="anchor" aria-hidden="true" href="#nikon">#</a></h3>
<p>尼康的情况最为简单，测试机型是 Z6，输出的是 NEF 文件。直接用 libraw 读取或者转成 dng 读取，得到的图像尺寸都是 (6064, 4040)，除了图像没有多余的区域，内容也完全一样。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>通常来说，最方便的做法总是转换成 DNG，这样既缩小了文件体积，又统一了格式，还裁切掉了各种图像以外的区域，便于后续处理。如果希望保留原始格式，元数据和被裁切的区域，则可以用 libraw 或 rawpy 直接读取原始 RAW 文件。经过各种测试，在绝大多数情况下，重合的图像区域里，像素值是完全一致的。</p>
<p>不推荐使用 Adobe 以外的软件来转换 RAW 到 DNG。Dcraw 由于停止维护，推荐迁移至 libraw/rawpy。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://jackchou.top/tags/colour/">Colour</a></li>
      <li><a href="https://jackchou.top/tags/isp/">ISP</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://jackchou.top/posts/colour-checker-for-jpg/">
    <span class="title">« 上一篇</span>
    <br>
    <span>并非色差：用色卡评价最终输出图像</span>
  </a>
  <a class="next" href="https://jackchou.top/posts/display-reflectance/">
    <span class="title">下一篇 »</span>
    <br>
    <span>反射率：高亮环境可读性的第二条路</span>
  </a>
</nav>


  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jackchou.top/">JacksBlog</a></span> · 
        my friends&rsquo; websites: <a href="https://zhxwu.com/">zhxwu.com</a>, <a href="https://ylqian.com/">ylqian.com</a> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div style="text-align: center; margin-top: 10px; margin-bottom: 20px; width: 100%; display: flex; justify-content: center;">
    <img src="https://visitor-badge.laobi.icu/badge?page_id=jacksblog" alt="visitors" width="88" height="20" style="height: auto;" loading="lazy" />
</div><script>
(() => {
    const images = document.querySelectorAll('.post-content img');
    if (!images.length) return;

    const overlay = document.createElement('div');
    overlay.className = 'image-lightbox';
    overlay.innerHTML = '<img class="image-lightbox__img" alt="" />';

    const overlayImg = overlay.querySelector('img');
    const closeOverlay = () => {
        overlay.classList.remove('is-visible');
        overlayImg.removeAttribute('src');
        document.body.style.removeProperty('overflow');
    };

    overlay.addEventListener('click', closeOverlay);
    document.addEventListener('keyup', (event) => {
        if (event.key === 'Escape' && overlay.classList.contains('is-visible')) {
            closeOverlay();
        }
    });

    document.body.appendChild(overlay);

    images.forEach((img) => {
        img.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();

            const source = img.dataset.zoomSrc || img.currentSrc || img.src;
            const cleanSrc = source.split('#')[0];

            overlayImg.src = cleanSrc;
            overlayImg.alt = img.alt || '';

            overlay.classList.add('is-visible');
            document.body.style.setProperty('overflow', 'hidden');
        });
    });
})();
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '拷贝';

        function copyingDone() {
            copybutton.innerHTML = '已拷贝';
            setTimeout(() => {
                copybutton.innerHTML = '拷贝';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
